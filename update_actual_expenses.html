<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update Actual Expenses - Faculty Development Fund</title>
    <!-- Version 1.2.0 - 2025-11-12 -->
    <!-- Changes: Enabled auto-load when requestId is in URL -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Calibri, Arial, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 3px solid #DB0A5B;
        }

        .header h1 {
            color: #DB0A5B;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section-title {
            color: #DB0A5B;
            font-size: 20px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e1e1e1;
        }

        .info-box {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 4px;
            border-left: 4px solid #DB0A5B;
            margin-bottom: 20px;
        }

        .info-box p {
            margin-bottom: 10px;
        }

        .info-box strong {
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: bold;
        }

        input[type="text"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: Calibri, sans-serif;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #DB0A5B;
        }

        /* Hide spinner arrows on number inputs */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type="number"] {
            -moz-appearance: textfield;
        }

        .required {
            color: #DB0A5B;
        }

        .expense-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .expense-table th,
        .expense-table td {
            padding: 12px;
            text-align: left;
            border: 1px solid #ddd;
        }

        .expense-table th {
            background-color: #DB0A5B;
            color: white;
            font-weight: bold;
        }

        .expense-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .expense-table input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .total-row {
            background-color: #f0f0f0 !important;
            font-weight: bold;
        }

        .total-row td {
            font-size: 16px;
        }

        .button {
            background-color: #DB0A5B;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .button:hover {
            background-color: #b00848;
        }

        .button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .button-secondary {
            background-color: #666;
        }

        .button-secondary:hover {
            background-color: #555;
        }

        .success-message {
            background-color: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
            display: none;
            text-align: center;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #DB0A5B;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            color: #c00;
            font-weight: bold;
            margin-top: 10px;
            padding: 15px;
            background-color: #ffe6e6;
            border-radius: 4px;
            display: none;
            text-align: center;
        }

        #lookupSection {
            display: block;
        }

        #updateSection {
            display: none;
        }

        .mileage-miles-input {
            border: 2px solid #DB0A5B !important;
        }

        .calculated-amount {
            color: #DB0A5B;
            font-weight: bold;
            font-size: 14px;
            margin-top: 5px;
        }

        .anticipated-value {
            background-color: #f9f9f9;
            padding: 8px;
            border-radius: 4px;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 22px;
            }
            
            .expense-table {
                font-size: 12px;
            }
            
            .expense-table th,
            .expense-table td {
                padding: 6px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Update Actual Expenses</h1>
            <p style="font-style: italic; font-weight: bold; font-size: 18px; margin-top: 10px;">Recording your completed activity expenses.</p>
            <p>Muskingum University</p>
        </div>

        <!-- Lookup Section -->
        <div id="lookupSection">
            <div class="section">
                <h2 class="section-title">Find Your Request</h2>
                
                <div class="info-box">
                    <h3>Instructions</h3>
                    <p>Enter your Request ID from your original Faculty Development Fund submission.</p>
                    <p><strong>Example:</strong> FDF-20251111-ea0978</p>
                </div>

                <div class="form-group">
                    <label for="requestIdLookup">
                        Request ID <span class="required">*</span>
                    </label>
                    <input type="text" id="requestIdLookup" name="requestIdLookup" 
                           placeholder="FDF-20251111-ea0978" required>
                </div>

                <button type="button" class="button button-secondary" id="loadRequestBtn" onclick="loadRequest()">
                    Load Request
                </button>

                <div class="loading" id="loadingLookup">
                    <div class="loading-spinner"></div>
                    <p>Loading your request...</p>
                </div>

                <div class="error-message" id="errorMessageLookup"></div>
            </div>
        </div>

        <!-- Update Section (Hidden Initially) -->
        <div id="updateSection">
            <form id="updateExpensesForm">
                
                <!-- Request Information -->
                <div class="section">
                    <h2 class="section-title">Request Information</h2>
                    
                    <div class="info-box">
                        <p><strong>Request ID:</strong> <span id="displayRequestId"></span></p>
                        <p><strong>Faculty Name:</strong> <span id="displayFacultyName"></span></p>
                        <p><strong>Department:</strong> <span id="displayDepartment"></span></p>
                        <p><strong>Activity:</strong> <span id="displayActivity"></span></p>
                    </div>
                </div>

                <!-- Expense Update Section -->
                <div class="section">
                    <h2 class="section-title">Update Actual Expenses</h2>
                    <p style="margin-bottom: 15px;">
                        Enter the actual expenses you incurred. Your anticipated amounts are shown for reference.
                    </p>

                    <table class="expense-table">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Anticipated</th>
                                <th>Actual <span class="required">*</span></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Membership Dues</td>
                                <td><span id="anticipated-membershipDues" class="anticipated-value">$0.00</span></td>
                                <td><input type="number" step="0.01" min="0" id="membershipDuesActual" name="membershipDuesActual" placeholder="0.00" value="0"></td>
                            </tr>
                            <tr>
                                <td>Air Travel</td>
                                <td><span id="anticipated-airTravel" class="anticipated-value">$0.00</span></td>
                                <td><input type="number" step="0.01" min="0" id="airTravelActual" name="airTravelActual" placeholder="0.00" value="0"></td>
                            </tr>
                            <tr>
                                <td>Mileage <small>($0.70 per mile)</small></td>
                                <td>
                                    <span id="anticipated-mileage" class="anticipated-value">$0.00</span>
                                    <small id="anticipated-mileageMiles" style="display: block; margin-top: 5px; color: #666;"></small>
                                </td>
                                <td>
                                    <div style="display: flex; flex-direction: column; gap: 5px;">
                                        <input type="number" step="1" min="0" id="mileageActualMiles" name="mileageActualMiles" placeholder="Enter miles" value="0">
                                        <div class="calculated-amount">= $<span id="mileageActualCalc">0.00</span></div>
                                        <input type="hidden" id="mileageActual" name="mileageActual" value="0">
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>Ground Travel</td>
                                <td><span id="anticipated-groundTravel" class="anticipated-value">$0.00</span></td>
                                <td><input type="number" step="0.01" min="0" id="groundTravelActual" name="groundTravelActual" placeholder="0.00" value="0"></td>
                            </tr>
                            <tr>
                                <td>Registration Costs</td>
                                <td><span id="anticipated-registrationCosts" class="anticipated-value">$0.00</span></td>
                                <td><input type="number" step="0.01" min="0" id="registrationCostsActual" name="registrationCostsActual" placeholder="0.00" value="0"></td>
                            </tr>
                            <tr>
                                <td>Lodging</td>
                                <td><span id="anticipated-lodging" class="anticipated-value">$0.00</span></td>
                                <td><input type="number" step="0.01" min="0" id="lodgingActual" name="lodgingActual" placeholder="0.00" value="0"></td>
                            </tr>
                            <tr>
                                <td>Meals & Incidentals</td>
                                <td><span id="anticipated-mealsIncidentals" class="anticipated-value">$0.00</span></td>
                                <td><input type="number" step="0.01" min="0" id="mealsIncidentalsActual" name="mealsIncidentalsActual" placeholder="0.00" value="0"></td>
                            </tr>
                            <tr>
                                <td>Other Expenses</td>
                                <td><span id="anticipated-otherExpense" class="anticipated-value">$0.00</span></td>
                                <td><input type="number" step="0.01" min="0" id="otherExpenseActual" name="otherExpenseActual" placeholder="0.00" value="0"></td>
                            </tr>
                            <tr class="total-row">
                                <td>TOTAL</td>
                                <td><span id="anticipated-total">$0.00</span></td>
                                <td><strong>$<span id="actualTotal">0.00</span></strong></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Hidden Fields -->
                <input type="hidden" id="recordId" name="recordId">
                <input type="hidden" id="requestId" name="requestId">
                <input type="hidden" id="totalActual" name="totalActual">

                <!-- Submit Button -->
                <div style="margin-top: 30px; text-align: center;">
                    <button type="submit" class="button" id="submitBtn">
                        Submit Actual Expenses
                    </button>
                </div>

                <div class="loading" id="loadingSubmit">
                    <div class="loading-spinner"></div>
                    <p>Submitting your expenses...</p>
                </div>

                <div class="success-message" id="successMessage">
                    <strong>Success!</strong> Your actual expenses have been updated.
                    <p style="margin-top: 10px;">You will receive a confirmation email shortly.</p>
                </div>

                <div class="error-message" id="errorMessageSubmit"></div>
            </form>
        </div>
    </div>

    <script>
        const MILEAGE_RATE = 0.70;

        // Auto-fill Request ID from URL parameter when page loads
        window.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const requestId = urlParams.get('requestId');
            
            if (requestId) {
                // Auto-fill the Request ID field
                document.getElementById('requestIdLookup').value = requestId;
                
                // Automatically load the request
                loadRequest();
            }
        });

        // Show/hide loading spinner
        function showLoading(elementId) {
            document.getElementById(elementId).style.display = 'block';
        }

        function hideLoading(elementId) {
            document.getElementById(elementId).style.display = 'none';
        }

        // Show/hide error messages
        function showError(message, elementId) {
            const errorElement = document.getElementById(elementId);
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }

        function hideError(elementId) {
            document.getElementById(elementId).style.display = 'none';
        }

        // Load Request Function
        async function loadRequest() {
            const requestId = document.getElementById('requestIdLookup').value.trim();
            
            if (!requestId) {
                showError('Please enter a Request ID', 'errorMessageLookup');
                return;
            }

            showLoading('loadingLookup');
            hideError('errorMessageLookup');

            // LOOKUP FLOW URL - This flow retrieves the request by ID
            const lookupFlowUrl = 'https://defaultcb41821671ce4827beea96b956d0a0.04.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/8efa0266db72440fb7e910a671f6358f/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=TtSKuzIlyTXlpqyZFVTRA1P7AYutz6-mX4NDXQEsL7Q';

            try {
                const response = await fetch(lookupFlowUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        RequestID: requestId
                    })
                });

                hideLoading('loadingLookup');

                if (!response.ok) {
                    throw new Error(`Request failed: ${response.status}`);
                }

                const data = await response.json();

                if (data.success === false || !data.ID) {
                    showError('Request ID not found. Please check your Request ID and try again.', 'errorMessageLookup');
                    return;
                }

                // Populate form with data
                populateForm(data);
                
                // Hide lookup section, show update section
                document.getElementById('lookupSection').style.display = 'none';
                document.getElementById('updateSection').style.display = 'block';

            } catch (error) {
                hideLoading('loadingLookup');
                showError('Error loading request: ' + error.message, 'errorMessageLookup');
            }
        }

        // Populate Form with Retrieved Data
        function populateForm(data) {
            // Set request information
            document.getElementById('displayRequestId').textContent = data.RequestID || '';
            document.getElementById('displayFacultyName').textContent = data.FacultyName || '';
            document.getElementById('displayDepartment').textContent = data.Department || '';
            document.getElementById('displayActivity').textContent = data.EligibleActivities || '';

            // Set hidden fields
            document.getElementById('recordId').value = data.ID || '';
            document.getElementById('requestId').value = data.RequestID || '';

            // Populate anticipated expenses
            document.getElementById('anticipated-membershipDues').textContent = '$' + parseFloat(data.MembershipDues || 0).toFixed(2);
            document.getElementById('anticipated-airTravel').textContent = '$' + parseFloat(data.AirTravel || 0).toFixed(2);
            document.getElementById('anticipated-mileage').textContent = '$' + parseFloat(data.Mileage || 0).toFixed(2);
            document.getElementById('anticipated-groundTravel').textContent = '$' + parseFloat(data.GroundTravel || 0).toFixed(2);
            document.getElementById('anticipated-registrationCosts').textContent = '$' + parseFloat(data.RegistrationCosts || 0).toFixed(2);
            document.getElementById('anticipated-lodging').textContent = '$' + parseFloat(data.Lodging || 0).toFixed(2);
            document.getElementById('anticipated-mealsIncidentals').textContent = '$' + parseFloat(data.MealsIncidentals || 0).toFixed(2);
            document.getElementById('anticipated-otherExpense').textContent = '$' + parseFloat(data.OtherExpense || 0).toFixed(2);
            
            // Show anticipated miles if available
            if (data.MileageMiles && data.MileageMiles > 0) {
                document.getElementById('anticipated-mileageMiles').textContent = '(' + data.MileageMiles + ' miles)';
            }

            // Calculate and display anticipated total
            const anticipatedTotal = 
                parseFloat(data.MembershipDues || 0) +
                parseFloat(data.AirTravel || 0) +
                parseFloat(data.Mileage || 0) +
                parseFloat(data.GroundTravel || 0) +
                parseFloat(data.RegistrationCosts || 0) +
                parseFloat(data.Lodging || 0) +
                parseFloat(data.MealsIncidentals || 0) +
                parseFloat(data.OtherExpense || 0);
            
            document.getElementById('anticipated-total').textContent = '$' + anticipatedTotal.toFixed(2);
        }

        // Calculate Mileage
        document.getElementById('mileageActualMiles').addEventListener('input', function() {
            const miles = parseFloat(this.value) || 0;
            const dollars = miles * MILEAGE_RATE;
            document.getElementById('mileageActualCalc').textContent = dollars.toFixed(2);
            document.getElementById('mileageActual').value = dollars.toFixed(2);
            calculateActualTotal();
        });

        // Calculate Actual Total
        function calculateActualTotal() {
            const membershipDues = parseFloat(document.getElementById('membershipDuesActual').value) || 0;
            const airTravel = parseFloat(document.getElementById('airTravelActual').value) || 0;
            const mileage = parseFloat(document.getElementById('mileageActual').value) || 0;
            const groundTravel = parseFloat(document.getElementById('groundTravelActual').value) || 0;
            const registrationCosts = parseFloat(document.getElementById('registrationCostsActual').value) || 0;
            const lodging = parseFloat(document.getElementById('lodgingActual').value) || 0;
            const mealsIncidentals = parseFloat(document.getElementById('mealsIncidentalsActual').value) || 0;
            const otherExpense = parseFloat(document.getElementById('otherExpenseActual').value) || 0;

            const total = membershipDues + airTravel + mileage + groundTravel + registrationCosts + lodging + mealsIncidentals + otherExpense;
            
            document.getElementById('actualTotal').textContent = total.toFixed(2);
            document.getElementById('totalActual').value = total.toFixed(2);
        }

        // Add event listeners to all actual expense inputs
        document.querySelectorAll('#membershipDuesActual, #airTravelActual, #groundTravelActual, #registrationCostsActual, #lodgingActual, #mealsIncidentalsActual, #otherExpenseActual').forEach(input => {
            input.addEventListener('input', calculateActualTotal);
        });

        // Submit Form
        document.getElementById('updateExpensesForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            showLoading('loadingSubmit');
            hideError('errorMessageSubmit');
            document.getElementById('submitBtn').disabled = true;

            // UPDATE FLOW URL - This flow updates the actual expenses
            const updateFlowUrl = 'https://defaultcb41821671ce4827beea96b956d0a0.04.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/1948f00c4576426bb282d071f9d4dedc/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=lUToLKlnPnrENYZHy5rHkA6ylrOO9iY_yiQ1pHNBgZw';

            const payload = {
                ID: document.getElementById('recordId').value,
                RequestID: document.getElementById('requestId').value,
                MembershipDuesActual: parseFloat(document.getElementById('membershipDuesActual').value) || 0,
                AirTravelActual: parseFloat(document.getElementById('airTravelActual').value) || 0,
                MileageActual: parseFloat(document.getElementById('mileageActual').value) || 0,
                MileageActualMiles: parseFloat(document.getElementById('mileageActualMiles').value) || 0,
                GroundTravelActual: parseFloat(document.getElementById('groundTravelActual').value) || 0,
                RegistrationCostsActual: parseFloat(document.getElementById('registrationCostsActual').value) || 0,
                LodgingActual: parseFloat(document.getElementById('lodgingActual').value) || 0,
                MealsIncidentalsActual: parseFloat(document.getElementById('mealsIncidentalsActual').value) || 0,
                OtherExpenseActual: parseFloat(document.getElementById('otherExpenseActual').value) || 0,
                TotalActual: parseFloat(document.getElementById('totalActual').value) || 0
            };

            try {
                const response = await fetch(updateFlowUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                hideLoading('loadingSubmit');

                if (!response.ok) {
                    throw new Error(`Update failed: ${response.status}`);
                }

                const data = await response.json();

                if (data.success === false) {
                    showError(data.message || 'Failed to update expenses', 'errorMessageSubmit');
                    document.getElementById('submitBtn').disabled = false;
                    return;
                }

                // Show success message
                document.getElementById('successMessage').style.display = 'block';
                document.getElementById('submitBtn').style.display = 'none';

            } catch (error) {
                hideLoading('loadingSubmit');
                showError('Error submitting expenses: ' + error.message, 'errorMessageSubmit');
                document.getElementById('submitBtn').disabled = false;
            }
        });
    </script>
</body>
</html>
