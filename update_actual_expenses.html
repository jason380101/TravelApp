<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update Actual Expenses - Muskingum University</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        // Mileage rate
        const MILEAGE_RATE = 0.70;
    </script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: Calibri, 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #DB0A5B;
            padding-bottom: 20px;
        }

        .header h1 {
            color: #DB0A5B;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 16px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section-title {
            color: #DB0A5B;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #DB0A5B;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
        }

        .required {
            color: #DB0A5B;
        }

        input[type="text"],
        input[type="number"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e1e1;
            border-radius: 4px;
            font-size: 14px;
            font-family: Calibri, sans-serif;
            transition: border-color 0.3s;
        }

        /* Remove spinner arrows from number inputs */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type="number"] {
            -moz-appearance: textfield;
        }

        input:focus {
            outline: none;
            border-color: #DB0A5B;
        }

        input:disabled {
            background-color: #f5f5f5;
            cursor: not-allowed;
        }

        .info-box {
            background-color: #f0f8ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .info-box h3 {
            color: #2196F3;
            margin-bottom: 10px;
        }

        .expense-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .expense-table th {
            background-color: #DB0A5B;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: bold;
        }

        .expense-table td {
            padding: 10px;
            border: 1px solid #ddd;
        }

        .expense-table input[type="number"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .expense-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .total-row {
            background-color: #f0f0f0 !important;
            font-weight: bold;
        }

        .total-row td {
            border-top: 2px solid #DB0A5B;
            padding: 15px 10px;
        }

        .anticipated-value {
            color: #666;
            font-weight: bold;
        }

        .button {
            background-color: #DB0A5B;
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 4px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
            display: block;
            margin: 30px auto 0;
        }

        .button:hover {
            background-color: #B00850;
        }

        .button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .button-secondary {
            background-color: #2196F3;
            margin: 10px auto;
        }

        .button-secondary:hover {
            background-color: #1976D2;
        }

        .loading {
            display: none;
            text-align: center;
            margin-top: 20px;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #DB0A5B;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success-message {
            color: #008000;
            font-weight: bold;
            margin-top: 10px;
            padding: 15px;
            background-color: #e6ffe6;
            border-radius: 4px;
            display: none;
            text-align: center;
        }

        .error-message {
            color: #c00;
            font-weight: bold;
            margin-top: 10px;
            padding: 15px;
            background-color: #ffe6e6;
            border-radius: 4px;
            display: none;
            text-align: center;
        }

        #lookupSection {
            display: block;
        }

        #updateSection {
            display: none;
        }

        .mileage-miles-input {
            border: 2px solid #DB0A5B !important;
        }

        .calculated-amount {
            color: #DB0A5B;
            font-weight: bold;
            font-size: 14px;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 22px;
            }
            
            .expense-table {
                font-size: 12px;
            }
            
            .expense-table th,
            .expense-table td {
                padding: 6px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Update Actual Expenses</h1>
            <p style="font-style: italic; font-weight: bold; font-size: 18px; margin-top: 10px;">Recording your completed activity expenses.</p>
            <p>Muskingum University</p>
        </div>

        <!-- Lookup Section -->
        <div id="lookupSection">
            <div class="section">
                <h2 class="section-title">Find Your Request</h2>
                
                <div class="info-box">
                    <h3>Instructions</h3>
                    <p>Enter your Request ID from your original Faculty Development Fund submission.</p>
                    <p><strong>Example:</strong> FDF-20251111-ea0978</p>
                </div>

                <div class="form-group">
                    <label for="requestIdLookup">
                        Request ID <span class="required">*</span>
                    </label>
                    <input type="text" id="requestIdLookup" name="requestIdLookup" 
                           placeholder="FDF-20251111-ea0978" required>
                </div>

                <button type="button" class="button button-secondary" id="loadRequestBtn" onclick="loadRequest()">
                    Load Request
                </button>

                <div class="loading" id="loadingLookup">
                    <div class="loading-spinner"></div>
                    <p>Loading your request...</p>
                </div>

                <div class="error-message" id="errorMessageLookup"></div>
            </div>
        </div>

        <!-- Update Section (Hidden Initially) -->
        <div id="updateSection">
            <form id="updateExpensesForm">
                
                <!-- Request Information -->
                <div class="section">
                    <h2 class="section-title">Request Information</h2>
                    
                    <div class="info-box">
                        <p><strong>Request ID:</strong> <span id="displayRequestId"></span></p>
                        <p><strong>Faculty Name:</strong> <span id="displayFacultyName"></span></p>
                        <p><strong>Department:</strong> <span id="displayDepartment"></span></p>
                        <p><strong>Activity:</strong> <span id="displayActivity"></span></p>
                    </div>
                </div>

                <!-- Expense Update Section -->
                <div class="section">
                    <h2 class="section-title">Update Actual Expenses</h2>
                    <p style="margin-bottom: 15px;">
                        Enter the actual expenses you incurred. Your anticipated amounts are shown for reference.
                    </p>

                    <table class="expense-table">
                        <thead>
                            <tr>
                                <th>Expense Category</th>
                                <th>Anticipated</th>
                                <th>Actual</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Membership Dues</td>
                                <td class="anticipated-value" id="antiMembershipDues">$0</td>
                                <td><input type="number" step="0.01" min="0" id="membershipDuesActual" value="0" class="expense-input-actual"></td>
                            </tr>
                            <tr>
                                <td>Air Travel</td>
                                <td class="anticipated-value" id="antiAirTravel">$0</td>
                                <td><input type="number" step="0.01" min="0" id="airTravelActual" value="0" class="expense-input-actual"></td>
                            </tr>
                            <tr>
                                <td>Mileage <small>($0.70 per mile)</small></td>
                                <td class="anticipated-value" id="antiMileage">$0 (0 miles)</td>
                                <td>
                                    <div style="display: flex; flex-direction: column; gap: 5px;">
                                        <input type="number" step="1" min="0" id="mileageActualMiles" value="0" placeholder="Enter miles" class="mileage-miles-input">
                                        <div class="calculated-amount">= $<span id="mileageActualCalc">0.00</span></div>
                                        <input type="hidden" id="mileageActual" value="0" class="expense-input-actual">
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>Other Ground Travel</td>
                                <td class="anticipated-value" id="antiGroundTravel">$0</td>
                                <td><input type="number" step="0.01" min="0" id="groundTravelActual" value="0" class="expense-input-actual"></td>
                            </tr>
                            <tr>
                                <td>Registration Costs</td>
                                <td class="anticipated-value" id="antiRegistrationCosts">$0</td>
                                <td><input type="number" step="0.01" min="0" id="registrationCostsActual" value="0" class="expense-input-actual"></td>
                            </tr>
                            <tr>
                                <td>Lodging</td>
                                <td class="anticipated-value" id="antiLodging">$0</td>
                                <td><input type="number" step="0.01" min="0" id="lodgingActual" value="0" class="expense-input-actual"></td>
                            </tr>
                            <tr>
                                <td>Meals & Incidentals</td>
                                <td class="anticipated-value" id="antiMealsIncidentals">$0</td>
                                <td><input type="number" step="0.01" min="0" id="mealsIncidentalsActual" value="0" class="expense-input-actual"></td>
                            </tr>
                            <tr>
                                <td>Other Expense</td>
                                <td class="anticipated-value" id="antiOtherExpense">$0</td>
                                <td><input type="number" step="0.01" min="0" id="otherExpenseActual" value="0" class="expense-input-actual"></td>
                            </tr>
                            <tr class="total-row">
                                <td><strong>TOTAL</strong></td>
                                <td class="anticipated-value" id="antiTotalAnticipated">$0</td>
                                <td><strong>$<span id="totalActual">0.00</span></strong></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Hidden Fields -->
                <input type="hidden" id="sharePointItemId" name="sharePointItemId">
                <input type="hidden" id="requestId" name="requestId">

                <!-- Submit Button -->
                <button type="submit" class="button" id="submitBtn">Submit Actual Expenses</button>

                <!-- Loading indicator -->
                <div class="loading" id="loadingSubmit">
                    <div class="loading-spinner"></div>
                    <p>Updating your expenses...</p>
                </div>

                <!-- Success/Error messages -->
                <div class="success-message" id="successMessage"></div>
                <div class="error-message" id="errorMessage"></div>

            </form>
        </div>
    </div>

    <script>
        // SharePoint configuration
        const SHAREPOINT_SITE = 'https://muskingum.sharepoint.com/sites/aa_academicaffairs-public';
        const SHAREPOINT_LIST = 'Faculty Development Fund Requests';

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeMileageCalculator();
            initializeExpenseCalculator();
        });

        // Initialize mileage calculator
        function initializeMileageCalculator() {
            const mileageActualInput = document.getElementById('mileageActualMiles');
            
            mileageActualInput.addEventListener('input', function() {
                const miles = parseFloat(this.value) || 0;
                const dollars = miles * MILEAGE_RATE;
                document.getElementById('mileageActualCalc').textContent = dollars.toFixed(2);
                document.getElementById('mileageActual').value = dollars.toFixed(2);
                calculateTotals();
            });
        }

        // Initialize expense calculator
        function initializeExpenseCalculator() {
            const actualInputs = document.querySelectorAll('.expense-input-actual');
            
            actualInputs.forEach(input => {
                input.addEventListener('input', calculateTotals);
            });
        }

        // Calculate totals
        function calculateTotals() {
            const actualInputs = document.querySelectorAll('.expense-input-actual');
            let actualTotal = 0;
            
            actualInputs.forEach(input => {
                actualTotal += parseFloat(input.value) || 0;
            });
            
            document.getElementById('totalActual').textContent = actualTotal.toFixed(2);
        }

        // Load request from SharePoint
        async function loadRequest() {
        const requestId = document.getElementById('requestIdLookup').value.trim();
    
        if (!requestId) {
            showError('Please enter a Request ID', 'errorMessageLookup');
            return;

        const flowUrl = 'https://defaultcb41821671ce4827beea96b956d0a0.04.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/8efa0266db72440fb7e910a671f6358f/triggers/manual/paths/invoke?api-version=1';  // ← PASTE HERE
    }

    showLoading('loadingLookup');
    hideError('errorMessageLookup');

    const flowUrl = 'PASTE_YOUR_ACTUAL_FLOW_URL_HERE';  // ← PASTE HERE
            }

            // Show loading
            document.getElementById('loadRequestBtn').disabled = true;
            document.getElementById('loadingLookup').style.display = 'block';
            document.getElementById('errorMessageLookup').style.display = 'none';

            try {
                // Call Power Automate flow to fetch the SharePoint item
                const flowUrl = 'YOUR_LOOKUP_FLOW_URL_HERE'; // You'll need to create this flow
                
                const response = await axios.post(flowUrl, {
                    RequestID: requestId
                });

                if (response.data && response.data.found) {
                    // Populate the form with the data
                    populateForm(response.data);
                    
                    // Hide lookup section, show update section
                    document.getElementById('lookupSection').style.display = 'none';
                    document.getElementById('updateSection').style.display = 'block';
                } else {
                    showError('errorMessageLookup', 'Request ID not found. Please check and try again.');
                }

            } catch (error) {
                console.error('Lookup error:', error);
                showError('errorMessageLookup', 'Failed to load request. Please try again or contact IT support.');
            } finally {
                document.getElementById('loadRequestBtn').disabled = false;
                document.getElementById('loadingLookup').style.display = 'none';
            }
        }

        // Populate form with SharePoint data
        function populateForm(data) {
            // Store item ID for update
            document.getElementById('sharePointItemId').value = data.ID;
            document.getElementById('requestId').value = data.RequestID;

            // Display request info
            document.getElementById('displayRequestId').textContent = data.RequestID;
            document.getElementById('displayFacultyName').textContent = data.FacultyName;
            document.getElementById('displayDepartment').textContent = data.Department;
            document.getElementById('displayActivity').textContent = data.ActivityDescription;

            // Populate anticipated values
            document.getElementById('antiMembershipDues').textContent = '$' + (data.MembershipDues || 0);
            document.getElementById('antiAirTravel').textContent = '$' + (data.AirTravel || 0);
            document.getElementById('antiMileage').textContent = '$' + (data.Mileage || 0) + ' (' + (data.MileageMiles || 0) + ' miles)';
            document.getElementById('antiGroundTravel').textContent = '$' + (data.GroundTravel || 0);
            document.getElementById('antiRegistrationCosts').textContent = '$' + (data.RegistrationCosts || 0);
            document.getElementById('antiLodging').textContent = '$' + (data.Lodging || 0);
            document.getElementById('antiMealsIncidentals').textContent = '$' + (data.MealsIncidentals || 0);
            document.getElementById('antiOtherExpense').textContent = '$' + (data.OtherExpense || 0);
            document.getElementById('antiTotalAnticipated').textContent = '$' + (data.TotalAnticipated || 0);

            // Pre-fill actual values if they exist
            document.getElementById('membershipDuesActual').value = data.MembershipDuesActual || 0;
            document.getElementById('airTravelActual').value = data.AirTravelActual || 0;
            document.getElementById('mileageActualMiles').value = data.MileageActualMiles || 0;
            document.getElementById('mileageActual').value = data.MileageActual || 0;
            document.getElementById('groundTravelActual').value = data.GroundTravelActual || 0;
            document.getElementById('registrationCostsActual').value = data.RegistrationCostsActual || 0;
            document.getElementById('lodgingActual').value = data.LodgingActual || 0;
            document.getElementById('mealsIncidentalsActual').value = data.MealsIncidentalsActual || 0;
            document.getElementById('otherExpenseActual').value = data.OtherExpenseActual || 0;

            // Trigger mileage calculation
            const mileageEvent = new Event('input');
            document.getElementById('mileageActualMiles').dispatchEvent(mileageEvent);

            // Calculate totals
            calculateTotals();
        }

        // Form submission
        document.getElementById('updateExpensesForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            // Show loading
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('loadingSubmit').style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';

            // Gather actual expense data
            const updateData = {
                ID: document.getElementById('sharePointItemId').value,
                RequestID: document.getElementById('requestId').value,
                MembershipDuesActual: parseFloat(document.getElementById('membershipDuesActual').value) || 0,
                AirTravelActual: parseFloat(document.getElementById('airTravelActual').value) || 0,
                MileageActual: parseFloat(document.getElementById('mileageActual').value) || 0,
                MileageActualMiles: parseFloat(document.getElementById('mileageActualMiles').value) || 0,
                GroundTravelActual: parseFloat(document.getElementById('groundTravelActual').value) || 0,
                RegistrationCostsActual: parseFloat(document.getElementById('registrationCostsActual').value) || 0,
                LodgingActual: parseFloat(document.getElementById('lodgingActual').value) || 0,
                MealsIncidentalsActual: parseFloat(document.getElementById('mealsIncidentalsActual').value) || 0,
                OtherExpenseActual: parseFloat(document.getElementById('otherExpenseActual').value) || 0,
                TotalActual: parseFloat(document.getElementById('totalActual').textContent)
            };

            try {
                // Call Power Automate flow to update SharePoint
                const flowUrl = 'https://defaultcb41821671ce4827beea96b956d0a0.04.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/8efa0266db72440fb7e910a671f6358f/triggers/manual/paths/invoke?api-version=1'; // You'll need to create this flow
                
                const response = await axios.post(flowUrl, updateData);

                // Hide loading
                document.getElementById('loadingSubmit').style.display = 'none';

                // Show success message
                const successMessage = document.getElementById('successMessage');
                successMessage.innerHTML = `
                    <h3>✓ Actual Expenses Updated Successfully!</h3>
                    <p>Your actual expenses have been recorded for Request ID: ${updateData.RequestID}</p>
                    <p>You will receive a confirmation email shortly.</p>
                `;
                successMessage.style.display = 'block';

                // Scroll to success message
                successMessage.scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                console.error('Update error:', error);

                // Hide loading
                document.getElementById('loadingSubmit').style.display = 'none';
                document.getElementById('submitBtn').disabled = false;

                showError('errorMessage', 'Failed to update expenses. Please try again or contact IT support if the problem persists.');
            }
        });

        // Helper function to show error messages
        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }
    </script>
</body>
</html>
