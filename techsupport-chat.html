<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tech Support Chat - Muskingum University</title>
  
  <!--
  ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
  ‚ïë                  MUSKINGUM CNS TECH SUPPORT CHAT                           ‚ïë
  ‚ïë                                                                            ‚ïë
  ‚ïë  Version:        1.1.3                                                     ‚ïë
  ‚ïë  Last Updated:   2024-12-04                                                ‚ïë
  ‚ïë  Author:         Jason - Business Analyst, Muskingum University           ‚ïë
  ‚ïë  Repository:     github.com/jason380101/Techsupportchatbot                ‚ïë
  ‚ïë  Deploy URL:     golden-mochi-23a5e1.netlify.app                          ‚ïë
  ‚ïë                                                                            ‚ïë
  ‚ïë  DESCRIPTION:                                                              ‚ïë
  ‚ïë  Interactive tech support chat widget for Muskingum University CNS        ‚ïë
  ‚ïë  department. Routes user questions through Cloudflare Workers gateway     ‚ïë
  ‚ïë  to n8n workflow, integrating with AI-powered chatbot backend.            ‚ïë
  ‚ïë                                                                            ‚ïë
  ‚ïë  ARCHITECTURE:                                                             ‚ïë
  ‚ïë  User ‚Üí HTML Chat ‚Üí Cloudflare Workers Gateway ‚Üí n8n ‚Üí AI Chatbot         ‚ïë
  ‚ïë                                                                            ‚ïë
  ‚ïë  ENDPOINTS:                                                                ‚ïë
  ‚ïë  - Chat: muskingum-chatbot-gateway.jasonn-1e6.workers.dev/techsupport    ‚ïë
  ‚ïë  - Feedback: muskie-automation.app.n8n.cloud/webhook/chatbot-feedback    ‚ïë
  ‚ïë                                                                            ‚ïë
  ‚ïë  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ‚ïë
  ‚ïë  CHANGELOG:                                                                ‚ïë
  ‚ïë  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ‚ïë
  ‚ïë                                                                            ‚ïë
  ‚ïë  v1.1.3 (2024-12-04) - USER FEEDBACK ENHANCEMENT                          ‚ïë
  ‚ïë    ‚úì Added "Thank you" confirmation message after feedback submission     ‚ïë
  ‚ïë    ‚úì Smooth fade-in/fade-out animation for feedback confirmation          ‚ïë
  ‚ïë    ‚úì Shows appreciation for user engagement                               ‚ïë
  ‚ïë                                                                            ‚ïë
  ‚ïë  v1.1.2 (2024-12-04) - BUG FIX                                            ‚ïë
  ‚ïë    ‚úì Fixed response parsing to handle data.message format                 ‚ïë
  ‚ïë    ‚úì Added HTML to text conversion (br tags to line breaks)               ‚ïë
  ‚ïë    ‚úì Now properly displays bot responses instead of raw JSON              ‚ïë
  ‚ïë                                                                            ‚ïë
  ‚ïë  v1.1.1 (2024-12-04) - UI IMPROVEMENT                                     ‚ïë
  ‚ïë    ‚úì Moved "Email CNS" button inline with feedback buttons                ‚ïë
  ‚ïë    ‚úì Better UX - escalate right where you give feedback                   ‚ïë
  ‚ïë    ‚úì Consistent button styling across feedback options                    ‚ïë
  ‚ïë                                                                            ‚ïë
  ‚ïë  v1.1.0 (2024-12-04) - EMAIL ESCALATION FEATURE                           ‚ïë
  ‚ïë    ‚úì Added "Email CNS" escalation button                                  ‚ïë
  ‚ïë    ‚úì Opens native email client with pre-filled information                ‚ïë
  ‚ïë    ‚úì Includes session ID and conversation context in email body           ‚ïë
  ‚ïë    ‚úì Styled to match Muskingum branding                                   ‚ïë
  ‚ïë                                                                            ‚ïë
  ‚ïë  v1.0.0 (2024-12-04) - INITIAL PRODUCTION VERSION                         ‚ïë
  ‚ïë    ‚úì Chat interface with Muskingum branding                               ‚ïë
  ‚ïë    ‚úì Integration with Cloudflare Workers gateway                          ‚ïë
  ‚ïë    ‚úì Real-time message exchange with AI chatbot                           ‚ïë
  ‚ïë    ‚úì Thumbs up/down feedback system                                       ‚ïë
  ‚ïë    ‚úì Typing indicator for bot responses                                   ‚ïë
  ‚ïë    ‚úì Session ID tracking for conversation continuity                      ‚ïë
  ‚ïë    ‚úì Mobile responsive design                                             ‚ïë
  ‚ïë    ‚úì Error handling and user feedback                                     ‚ïë
  ‚ïë                                                                            ‚ïë
  ‚ïë  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ‚ïë
  ‚ïë  FUTURE ENHANCEMENTS (Planned):                                           ‚ïë
  ‚ïë    - File upload support for screenshots                                  ‚ïë
  ‚ïë    - Conversation history persistence                                     ‚ïë
  ‚ïë    - Rich text formatting in responses                                    ‚ïë
  ‚ïë    - Voice input option                                                   ‚ïë
  ‚ïë    - Download conversation transcript                                     ‚ïë
  ‚ïë                                                                            ‚ïë
  ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
  -->
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f5f5;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .chat-container {
      width: 100%;
      max-width: 600px;
      height: 90vh;
      max-height: 700px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .chat-header {
      background: linear-gradient(135deg, #6b2c3e 0%, #8b3a4f 100%);
      color: white;
      padding: 20px;
      text-align: center;
    }

    .chat-header h1 {
      font-size: 1.3rem;
      margin-bottom: 5px;
    }

    .chat-header p {
      font-size: 0.85rem;
      opacity: 0.9;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .message {
      display: flex;
      flex-direction: column;
      max-width: 85%;
    }

    .message.user {
      align-self: flex-end;
    }

    .message.bot {
      align-self: flex-start;
    }

    .message-content {
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 0.95rem;
      line-height: 1.5;
    }

    .message.user .message-content {
      background: #6b2c3e;
      color: white;
      border-bottom-right-radius: 4px;
    }

    .message.bot .message-content {
      background: #e9e9e9;
      color: #333;
      border-bottom-left-radius: 4px;
    }

    .feedback-buttons {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      padding-left: 5px;
      flex-wrap: wrap;
    }

    .feedback-btn {
      background: none;
      border: 1px solid #ddd;
      border-radius: 20px;
      padding: 5px 12px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .feedback-btn:hover {
      background: #f0f0f0;
    }

    .feedback-btn.selected-up {
      background: #d4edda;
      border-color: #28a745;
      color: #28a745;
    }

    .feedback-btn.selected-down {
      background: #f8d7da;
      border-color: #dc3545;
      color: #dc3545;
    }

    .feedback-btn:disabled {
      cursor: not-allowed;
      opacity: 0.6;
    }

    .escalation-btn {
      background: none;
      border: 1px solid #6b2c3e;
      border-radius: 20px;
      padding: 5px 12px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 4px;
      color: #6b2c3e;
      text-decoration: none;
    }

    .escalation-btn:hover {
      background: #6b2c3e;
      color: white;
    }

    .escalation-btn svg {
      width: 14px;
      height: 14px;
    }

    .feedback-confirmation {
      font-size: 0.8rem;
      color: #28a745;
      margin-top: 6px;
      padding-left: 5px;
      opacity: 0;
      animation: fadeInOut 3s ease-in-out;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateY(-5px); }
      15% { opacity: 1; transform: translateY(0); }
      85% { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(-5px); }
    }

    .typing-indicator {
      display: flex;
      gap: 5px;
      padding: 12px 16px;
      background: #e9e9e9;
      border-radius: 12px;
      width: fit-content;
    }

    .typing-indicator span {
      width: 8px;
      height: 8px;
      background: #999;
      border-radius: 50%;
      animation: bounce 1.4s infinite ease-in-out;
    }

    .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
    .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }

    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }

    .chat-input-container {
      padding: 15px 20px;
      border-top: 1px solid #eee;
      display: flex;
      gap: 10px;
    }

    .chat-input {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid #ddd;
      border-radius: 25px;
      font-size: 0.95rem;
      outline: none;
      transition: border-color 0.2s;
    }

    .chat-input:focus {
      border-color: #6b2c3e;
    }

    .send-btn {
      background: #6b2c3e;
      color: white;
      border: none;
      border-radius: 50%;
      width: 45px;
      height: 45px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }

    .send-btn:hover {
      background: #8b3a4f;
    }

    .send-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .send-btn svg {
      width: 20px;
      height: 20px;
    }

    .error-message {
      background: #f8d7da;
      color: #721c24;
      padding: 10px;
      border-radius: 8px;
      text-align: center;
      margin: 10px 20px;
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">
      <h1>üñ•Ô∏è Tech Support Chat</h1>
      <p>Computer & Network Services - Muskingum University</p>
    </div>
    
    <div class="chat-messages" id="chatMessages">
      <div class="message bot">
        <div class="message-content">
          Hello! I'm the CNS Tech Support assistant. I can help you with WiFi, email, passwords, computer labs, and other technology questions. How can I assist you today?
        </div>
      </div>
    </div>
    
    <div class="chat-input-container">
      <input 
        type="text" 
        class="chat-input" 
        id="chatInput" 
        placeholder="Type your question..." 
        autocomplete="off"
      >
      <button class="send-btn" id="sendBtn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 2L11 13M22 2L15 22L11 13L2 9L22 2Z"/>
        </svg>
      </button>
    </div>
  </div>

  <script>
    // ============================================================================
    // VERSION INFORMATION
    // ============================================================================
    const APP_VERSION = {
      version: '1.1.3',
      buildNumber: 5,
      lastUpdated: '2024-12-04',
      environment: 'production',
      author: 'Jason - Muskingum University'
    };

    // Log version information to console
    console.log('%cüéì Muskingum CNS Tech Support Chat', 'color: #6b2c3e; font-weight: bold; font-size: 16px;');
    console.log('%c Version: ' + APP_VERSION.version, 'color: #8b3a4f; font-size: 12px;');
    console.log('%c Updated: ' + APP_VERSION.lastUpdated, 'color: #666; font-size: 11px;');
    console.log('%c Build: #' + APP_VERSION.buildNumber, 'color: #666; font-size: 11px;');
    console.log('‚îÅ'.repeat(60));

    // ============================================================================
    // CONFIGURATION
    // ============================================================================
    const CONFIG = {
      chatEndpoint: 'https://muskingum-chatbot-gateway.jasonn-1e6.workers.dev/techsupport',
      feedbackEndpoint: 'https://muskie-automation.app.n8n.cloud/webhook/chatbot-feedback',
      botId: 'techsupport-bot',
      cnsEmail: 'cns@muskingum.edu',
      version: APP_VERSION.version
    };

    // ============================================================================
    // SESSION MANAGEMENT
    // ============================================================================
    // Generate unique session ID for conversation tracking
    const sessionId = 'session_' + Math.random().toString(36).substr(2, 9) + Date.now();
    console.log('Session ID:', sessionId);

    // ============================================================================
    // DOM ELEMENTS
    // ============================================================================
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');

    // ============================================================================
    // STATE MANAGEMENT
    // ============================================================================
    // Track conversation IDs for feedback
    let currentConversationId = null;
    
    // Store conversation history for email context
    let conversationHistory = [];

    // ============================================================================
    // ESCALATION FUNCTIONS
    // ============================================================================
    
    /**
     * Generate email escalation link with pre-filled information
     * @returns {string} mailto: URL with pre-filled content
     */
    function generateEscalationEmail() {
      const subject = 'Tech Support Request - Chat Session ' + sessionId.substr(-8);
      
      // Build email body with conversation context
      let body = 'Hello CNS Team,\n\n';
      body += 'I need additional help with my tech support request.\n\n';
      body += '---\n';
      body += 'CHAT SESSION INFORMATION\n';
      body += '---\n';
      body += 'Session ID: ' + sessionId + '\n';
      body += 'Date: ' + new Date().toLocaleString() + '\n';
      body += 'Chat Widget Version: ' + APP_VERSION.version + '\n\n';
      
      if (conversationHistory.length > 0) {
        body += '---\n';
        body += 'CONVERSATION HISTORY\n';
        body += '---\n';
        conversationHistory.forEach((msg, index) => {
          body += (index + 1) + '. ' + msg.sender.toUpperCase() + ': ' + msg.text + '\n\n';
        });
      }
      
      body += '---\n';
      body += 'ADDITIONAL DETAILS\n';
      body += '---\n';
      body += 'Please describe your issue in more detail:\n\n';
      body += '[Type your detailed description here]\n\n';
      body += 'Thank you!\n';
      
      // Encode for URL
      const encodedSubject = encodeURIComponent(subject);
      const encodedBody = encodeURIComponent(body);
      
      return `mailto:${CONFIG.cnsEmail}?subject=${encodedSubject}&body=${encodedBody}`;
    }

    /**
     * Handle escalation button click
     */
    function handleEscalation(e) {
      e.preventDefault();
      
      // Generate mailto link
      const mailtoLink = generateEscalationEmail();
      
      // Open email client
      window.location.href = mailtoLink;
      
      console.log('‚úâÔ∏è Escalation email opened');
      console.log('Session:', sessionId);
      console.log('Conversation length:', conversationHistory.length, 'messages');
    }

    // ============================================================================
    // CORE FUNCTIONS
    // ============================================================================
    
    /**
     * Send user message to chatbot and handle response
     */
    async function sendMessage() {
      const message = chatInput.value.trim();
      if (!message) return;

      // Disable input while processing
      chatInput.disabled = true;
      sendBtn.disabled = true;

      // Add user message to chat
      addMessage(message, 'user');
      
      // Store in conversation history
      conversationHistory.push({ sender: 'user', text: message });
      
      chatInput.value = '';

      // Show typing indicator
      const typingDiv = showTypingIndicator();

      try {
        const response = await fetch(CONFIG.chatEndpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            chatInput: message,
            sessionId: sessionId,
            version: APP_VERSION.version
          })
        });

        if (!response.ok) {
          throw new Error('Failed to get response');
        }

        const data = await response.json();
        
        // Remove typing indicator
        typingDiv.remove();

        // Extract response text (handle multiple response formats)
        let botResponse = '';
        if (typeof data === 'string') {
          botResponse = data;
        } else if (data.message) {
          // Handle { message: "..." } format
          botResponse = data.message;
        } else if (data.output) {
          botResponse = data.output;
        } else if (data.ChatResponse) {
          botResponse = data.ChatResponse;
        } else {
          botResponse = JSON.stringify(data);
        }

        // Convert HTML line breaks to actual line breaks
        botResponse = botResponse.replace(/<br\s*\/?>/gi, '\n');

        // Get conversation ID from response if available
        currentConversationId = data.conversationId || data.conversation_id || null;

        // Add bot message with feedback buttons
        addMessage(botResponse, 'bot', currentConversationId);
        
        // Store in conversation history
        conversationHistory.push({ sender: 'bot', text: botResponse });

      } catch (error) {
        typingDiv.remove();
        showError('Sorry, there was an error processing your request. Please try again.');
        console.error('Chat error:', error);
      }

      // Re-enable input
      chatInput.disabled = false;
      sendBtn.disabled = false;
      chatInput.focus();
    }

    /**
     * Add message to chat display
     * @param {string} text - Message text content
     * @param {string} sender - 'user' or 'bot'
     * @param {number|null} conversationId - Optional conversation ID for feedback
     */
    function addMessage(text, sender, conversationId = null) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${sender}`;

      const contentDiv = document.createElement('div');
      contentDiv.className = 'message-content';
      contentDiv.textContent = text;
      messageDiv.appendChild(contentDiv);

      // Add feedback buttons for bot messages
      if (sender === 'bot') {
        const feedbackDiv = document.createElement('div');
        feedbackDiv.className = 'feedback-buttons';
        
        // Build feedback buttons HTML
        let feedbackHTML = '';
        
        // Only add voting buttons if we have a conversation ID
        if (conversationId) {
          feedbackHTML += `
            <button class="feedback-btn" data-vote="1" data-conversation-id="${conversationId}">
              üëç Helpful
            </button>
            <button class="feedback-btn" data-vote="-1" data-conversation-id="${conversationId}">
              üëé Not Helpful
            </button>
          `;
        }
        
        // Always add escalation button
        feedbackHTML += `
          <a href="#" class="escalation-btn" data-escalation="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
            </svg>
            Email CNS
          </a>
        `;
        
        feedbackDiv.innerHTML = feedbackHTML;
        messageDiv.appendChild(feedbackDiv);

        // Add click handlers for feedback buttons
        if (conversationId) {
          feedbackDiv.querySelectorAll('.feedback-btn').forEach(btn => {
            btn.addEventListener('click', handleFeedback);
          });
        }
        
        // Add click handler for escalation button
        const escalationBtn = feedbackDiv.querySelector('.escalation-btn');
        if (escalationBtn) {
          escalationBtn.addEventListener('click', handleEscalation);
        }
      }

      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    /**
     * Show typing indicator while bot is "thinking"
     * @returns {HTMLElement} The typing indicator element
     */
    function showTypingIndicator() {
      const typingDiv = document.createElement('div');
      typingDiv.className = 'message bot';
      typingDiv.innerHTML = `
        <div class="typing-indicator">
          <span></span>
          <span></span>
          <span></span>
        </div>
      `;
      chatMessages.appendChild(typingDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      return typingDiv;
    }

    /**
     * Display error message to user
     * @param {string} text - Error message text
     */
    function showError(text) {
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error-message';
      errorDiv.textContent = text;
      chatMessages.appendChild(errorDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      
      // Remove after 5 seconds
      setTimeout(() => errorDiv.remove(), 5000);
    }

    /**
     * Handle user feedback (thumbs up/down)
     * @param {Event} e - Click event
     */
    async function handleFeedback(e) {
      const btn = e.currentTarget;
      const vote = parseInt(btn.dataset.vote);
      const conversationId = parseInt(btn.dataset.conversationId);

      // Disable all feedback buttons in this group (but not escalation button)
      const feedbackDiv = btn.parentElement;
      feedbackDiv.querySelectorAll('.feedback-btn').forEach(b => {
        b.disabled = true;
      });

      // Highlight selected button
      btn.classList.add(vote === 1 ? 'selected-up' : 'selected-down');

      // Show thank you message
      showFeedbackConfirmation(feedbackDiv, vote);

      try {
        await fetch(CONFIG.feedbackEndpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            conversation_id: conversationId,
            vote: vote,
            session_id: sessionId,
            version: APP_VERSION.version
          })
        });
        console.log('Feedback submitted:', vote === 1 ? 'Helpful' : 'Not helpful');
      } catch (error) {
        console.error('Feedback error:', error);
      }
    }

    /**
     * Show feedback confirmation message
     * @param {HTMLElement} feedbackDiv - The feedback buttons container
     * @param {number} vote - The vote value (1 or -1)
     */
    function showFeedbackConfirmation(feedbackDiv, vote) {
      // Check if confirmation already exists
      const existingConfirmation = feedbackDiv.parentElement.querySelector('.feedback-confirmation');
      if (existingConfirmation) {
        existingConfirmation.remove();
      }

      // Create confirmation message
      const confirmationDiv = document.createElement('div');
      confirmationDiv.className = 'feedback-confirmation';
      
      const message = vote === 1 
        ? '‚úì Thank you for your feedback! We\'re glad we could help.' 
        : '‚úì Thank you for your feedback. We\'ll work to improve our responses.';
      
      confirmationDiv.textContent = message;

      // Insert after feedback buttons
      feedbackDiv.parentElement.appendChild(confirmationDiv);

      // Remove after animation completes (3 seconds)
      setTimeout(() => {
        confirmationDiv.remove();
      }, 3000);
    }

    // ============================================================================
    // EVENT LISTENERS
    // ============================================================================
    sendBtn.addEventListener('click', sendMessage);
    chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });

    // ============================================================================
    // INITIALIZATION
    // ============================================================================
    // Focus input on load
    chatInput.focus();
    
    console.log('‚úì Chat initialized and ready');
    console.log('‚úì Response parsing: data.message, data.output, data.ChatResponse');
    console.log('‚úì Escalation button configured inline with feedback');
  </script>
</body>
</html>
