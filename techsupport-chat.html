<!DOCTYPE html>
<html lang="en">
<!--
  ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
  ‚ïë                  MUSKINGUM CNS TECH SUPPORT CHAT                           ‚ïë
  ‚ïë                                                                            ‚ïë
  ‚ïë  Version:        1.1.9                                                     ‚ïë
  ‚ïë  Last Updated:   2024-12-06                                                ‚ïë
  ‚ïë  Author:         Jason - Business Analyst, Muskingum University           ‚ïë
  ‚ïë  Repository:     github.com/jason380101/muskingum-apps                    ‚ïë
  ‚ïë  Deploy URL:     muskingum-apps.pages.dev                                 ‚ïë
  ‚ïë                                                                            ‚ïë
  ‚ïë  DESCRIPTION:                                                              ‚ïë
  ‚ïë  Interactive tech support chat widget for Muskingum University CNS        ‚ïë
  ‚ïë  department. Routes user questions through Cloudflare Workers gateway     ‚ïë
  ‚ïë  to n8n workflow, integrating with AI-powered chatbot backend.            ‚ïë
  ‚ïë                                                                            ‚ïë
  ‚ïë  ARCHITECTURE:                                                             ‚ïë
  ‚ïë  User ‚Üí HTML Chat ‚Üí Cloudflare Workers Gateway ‚Üí n8n ‚Üí AI Chatbot         ‚ïë
  ‚ïë                                                                            ‚ïë
  ‚ïë  ENDPOINTS:                                                                ‚ïë
  ‚ïë  - Chat: muskingum-chatbot-gateway.jasonn-1e6.workers.dev/techsupport    ‚ïë
  ‚ïë  - n8n: muskie-automation.app.n8n.cloud/webhook/techsupport-chat         ‚ïë
  ‚ïë  - Feedback: muskie-automation.app.n8n.cloud/webhook/chatbot-feedback    ‚ïë
  ‚ïë                                                                            ‚ïë
  ‚ïë  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ‚ïë
  ‚ïë  CHANGELOG:                                                                ‚ïë
  ‚ïë  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ‚ïë
  ‚ïë                                                                            ‚ïë
  ‚ïë  v1.1.9 (2024-12-06) - IMPROVED ERROR HANDLING                            ‚ïë
  ‚ïë    ‚úì Added specific error messages for different HTTP status codes        ‚ïë
  ‚ïë    ‚úì Rate limit errors (429) now show actionable messages                 ‚ïë
  ‚ïë    ‚úì Global limit errors (503) direct users to email CNS                  ‚ïë
  ‚ïë    ‚úì Bot detection errors (403) inform users to use regular browser       ‚ïë
  ‚ïë    ‚úì Bad request errors (400) provide helpful feedback                    ‚ïë
  ‚ïë    ‚úì Users get clear guidance instead of generic connection errors        ‚ïë
  ‚ïë                                                                            ‚ïë
  ‚ïë  v1.1.8 (2024-12-04) - URL PARSING FIX                                    ‚ïë
  ‚ïë    ‚úì Fixed trailing punctuation being included in URLs                    ‚ïë
  ‚ïë    ‚úì Periods, commas, and other punctuation excluded from links           ‚ïë
  ‚ïë    ‚úì Cleaner, more accurate clickable links                               ‚ïë
  ‚ïë                                                                            ‚ïë
  ‚ïë  v1.1.7 (2024-12-04) - DISPLAY FIX                                        ‚ïë
  ‚ïë    ‚úì Fixed message spacing/formatting issue                               ‚ïë
  ‚ïë    ‚úì Removed extra whitespace from welcome message                        ‚ïë
  ‚ïë    ‚úì Normalized CSS whitespace handling                                   ‚ïë
  ‚ïë    ‚úì Messages now display with proper, clean spacing                      ‚ïë
  ‚ïë                                                                            ‚ïë
  ‚ïë  v1.1.6 (2024-12-04) - MARKDOWN FORMATTING SUPPORT                        ‚ïë
  ‚ïë    ‚úì Bold text (**text**) now renders properly                            ‚ïë
  ‚ïë    ‚úì Italic text (*text*) now renders properly                            ‚ïë
  ‚ïë    ‚úì Improved text formatting for better readability                      ‚ïë
  ‚ïë    ‚úì No more visible asterisks in responses                               ‚ïë
  ‚ïë                                                                            ‚ïë
  ‚ïë  v1.1.5 (2024-12-04) - CLICKABLE LINKS FEATURE                            ‚ïë
  ‚ïë    ‚úì URLs in bot responses now automatically become clickable links       ‚ïë
  ‚ïë    ‚úì Links open in new tab with security attributes                       ‚ïë
  ‚ïë    ‚úì Supports http://, https://, and www. URLs                            ‚ïë
  ‚ïë    ‚úì Styled links to match Muskingum branding                             ‚ïë
  ‚ïë                                                                            ‚ïë
  ‚ïë  v1.1.4 (2024-12-04) - READABILITY FIX                                    ‚ïë
  ‚ïë    ‚úì Fixed line break rendering in bot responses                          ‚ïë
  ‚ïë    ‚úì Long text now displays with proper paragraph breaks                  ‚ïë
  ‚ïë    ‚úì Improved readability for multi-paragraph responses                   ‚ïë
  ‚ïë    ‚úì Sanitized HTML to prevent XSS while preserving formatting            ‚ïë
  ‚ïë                                                                            ‚ïë
  ‚ïë  v1.1.3 (2024-12-04) - USER FEEDBACK ENHANCEMENT                          ‚ïë
  ‚ïë    ‚úì Added "Thank you" confirmation message after feedback submission     ‚ïë
  ‚ïë    ‚úì Smooth fade-in/fade-out animation for feedback confirmation          ‚ïë
  ‚ïë    ‚úì Shows appreciation for user engagement                               ‚ïë
  ‚ïë                                                                            ‚ïë
  ‚ïë  v1.1.2 (2024-12-04) - BUG FIX                                            ‚ïë
  ‚ïë    ‚úì Fixed response parsing to handle data.message format                 ‚ïë
  ‚ïë    ‚úì Added HTML to text conversion (br tags to line breaks)               ‚ïë
  ‚ïë    ‚úì Now properly displays bot responses instead of raw JSON              ‚ïë
  ‚ïë                                                                            ‚ïë
  ‚ïë  v1.1.1 (2024-12-04) - UI IMPROVEMENT                                     ‚ïë
  ‚ïë    ‚úì Moved "Email CNS" button inline with feedback buttons                ‚ïë
  ‚ïë    ‚úì Better UX - escalate right where you give feedback                   ‚ïë
  ‚ïë    ‚úì Consistent button styling across feedback options                    ‚ïë
  ‚ïë                                                                            ‚ïë
  ‚ïë  v1.1.0 (2024-12-04) - EMAIL ESCALATION FEATURE                           ‚ïë
  ‚ïë    ‚úì Added "Email CNS" escalation button                                  ‚ïë
  ‚ïë    ‚úì Opens native email client with pre-filled information                ‚ïë
  ‚ïë    ‚úì Includes session ID and conversation context in email body           ‚ïë
  ‚ïë    ‚úì Styled to match Muskingum branding                                   ‚ïë
  ‚ïë                                                                            ‚ïë
  ‚ïë  v1.0.0 (2024-12-04) - INITIAL PRODUCTION VERSION                         ‚ïë
  ‚ïë    ‚úì Chat interface with Muskingum branding                               ‚ïë
  ‚ïë    ‚úì Integration with Cloudflare Workers gateway                          ‚ïë
  ‚ïë    ‚úì Real-time message exchange with AI chatbot                           ‚ïë
  ‚ïë    ‚úì Thumbs up/down feedback system                                       ‚ïë
  ‚ïë    ‚úì Typing indicator for bot responses                                   ‚ïë
  ‚ïë    ‚úì Session ID tracking for conversation continuity                      ‚ïë
  ‚ïë    ‚úì Mobile responsive design                                             ‚ïë
  ‚ïë    ‚úì Error handling and user feedback                                     ‚ïë
  ‚ïë                                                                            ‚ïë
  ‚ïë  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ‚ïë
  ‚ïë  FUTURE ENHANCEMENTS (Planned):                                           ‚ïë
  ‚ïë    - File upload support for screenshots                                  ‚ïë
  ‚ïë    - Conversation history persistence                                     ‚ïë
  ‚ïë    - Rich text formatting in responses                                    ‚ïë
  ‚ïë    - Voice input option                                                   ‚ïë
  ‚ïë    - Download conversation transcript                                     ‚ïë
  ‚ïë                                                                            ‚ïë
  ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
  -->
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tech Support - Muskingum University</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #6b2c3e 0%, #8b3a4f 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      color: #333;
    }

    .chat-container {
      width: 100%;
      max-width: 800px;
      height: 600px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .chat-header {
      background: linear-gradient(135deg, #6b2c3e 0%, #8b3a4f 100%);
      color: white;
      padding: 20px;
      text-align: center;
      border-radius: 16px 16px 0 0;
    }

    .chat-header h1 {
      font-size: 1.5rem;
      margin-bottom: 5px;
    }

    .chat-header p {
      font-size: 0.9rem;
      opacity: 0.9;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: #f5f5f5;
    }

    .message {
      margin-bottom: 16px;
      display: flex;
      align-items: flex-start;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message.user {
      flex-direction: row-reverse;
    }

    .message-content {
      max-width: 70%;
      padding: 12px 16px;
      border-radius: 12px;
      word-wrap: break-word;
      overflow-wrap: break-word;
      line-height: 1.5;
    }

    .message.bot .message-content {
      background: white;
      color: #333;
      border: 1px solid #e0e0e0;
      border-radius: 12px 12px 12px 2px;
    }

    .message.user .message-content {
      background: #6b2c3e;
      color: white;
      border-radius: 12px 12px 2px 12px;
    }

    .message-content strong {
      font-weight: 600;
    }

    .message-content em {
      font-style: italic;
    }

    .message-content a {
      color: #6b2c3e;
      text-decoration: underline;
      word-break: break-all;
    }

    .message.user .message-content a {
      color: #fff;
      text-decoration: underline;
    }

    .typing-indicator {
      display: none;
      padding: 12px 16px;
      background: white;
      border-radius: 12px;
      border: 1px solid #e0e0e0;
      max-width: 70px;
      margin-bottom: 16px;
    }

    .typing-indicator span {
      height: 8px;
      width: 8px;
      background: #6b2c3e;
      border-radius: 50%;
      display: inline-block;
      margin-right: 4px;
      animation: typing 1.4s infinite;
    }

    .typing-indicator span:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-indicator span:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes typing {
      0%, 60%, 100% {
        transform: translateY(0);
        opacity: 0.7;
      }
      30% {
        transform: translateY(-10px);
        opacity: 1;
      }
    }

    .chat-input-container {
      padding: 20px;
      background: white;
      border-top: 1px solid #e0e0e0;
      display: flex;
      gap: 10px;
      align-items: flex-end;
    }

    #chatInput {
      flex: 1;
      padding: 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 24px;
      font-size: 1rem;
      resize: none;
      font-family: inherit;
      max-height: 120px;
      min-height: 48px;
      overflow-y: auto;
      transition: border-color 0.3s;
    }

    #chatInput:focus {
      outline: none;
      border-color: #6b2c3e;
    }

    #chatSend {
      background: linear-gradient(135deg, #6b2c3e 0%, #8b3a4f 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 24px;
      font-size: 1rem;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      font-weight: 600;
      min-width: 80px;
    }

    #chatSend:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(107, 44, 62, 0.3);
    }

    #chatSend:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .feedback-buttons {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      opacity: 0;
      animation: fadeIn 0.3s ease forwards;
      animation-delay: 0.5s;
    }

    .feedback-btn {
      background: #f0f0f0;
      border: 1px solid #e0e0e0;
      padding: 6px 12px;
      border-radius: 16px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .feedback-btn:hover {
      background: #e0e0e0;
      transform: scale(1.05);
    }

    .feedback-btn.selected {
      background: #6b2c3e;
      color: white;
      border-color: #6b2c3e;
    }

    .feedback-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .email-cns-btn {
      background: #e3f2fd;
      border: 1px solid #2196f3;
      color: #1976d2;
    }

    .email-cns-btn:hover {
      background: #bbdefb;
    }

    .feedback-confirmation {
      margin-top: 8px;
      padding: 8px 12px;
      background: #e8f5e9;
      border: 1px solid #4caf50;
      border-radius: 8px;
      font-size: 0.85rem;
      color: #2e7d32;
      opacity: 0;
      animation: fadeInOut 3s ease forwards;
    }

    @keyframes fadeInOut {
      0% { opacity: 0; }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% { opacity: 0; }
    }

    .version-indicator {
      position: fixed;
      bottom: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-family: monospace;
    }

    @media (max-width: 768px) {
      .chat-container {
        height: 100vh;
        max-width: 100%;
        border-radius: 0;
      }

      .chat-header {
        border-radius: 0;
      }

      .message-content {
        max-width: 85%;
      }
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">
      <h1>üñ•Ô∏è Tech Support</h1>
      <p>How can we help you today?</p>
    </div>

    <div class="chat-messages" id="chatMessages">
      <div class="message bot">
        <div class="message-content">Hi! I'm your Muskingum University tech support assistant. I can help you with WiFi issues, password resets, email problems, and more. What do you need help with today?</div>
      </div>
      <div class="typing-indicator" id="typingIndicator">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>

    <div class="chat-input-container">
      <textarea 
        id="chatInput" 
        placeholder="Type your question here..."
        rows="1"
      ></textarea>
      <button id="chatSend">Send</button>
    </div>
  </div>

  <div class="version-indicator" id="versionIndicator">v1.1.9</div>

  <script>
    // Configuration
    const CONFIG = {
      chatEndpoint: 'https://muskingum-chatbot-gateway.jasonn-1e6.workers.dev/techsupport',
      feedbackEndpoint: 'https://muskie-automation.app.n8n.cloud/webhook/chatbot-feedback',
      cnsEmail: 'cns@muskingum.edu',
      sessionId: 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9)
    };

    // App version
    const APP_VERSION = {
      version: 'v1.1.9',
      build: 11,
      date: '2024-12-06',
      features: [
        'Feedback buttons',
        'Email CNS escalation',
        'Markdown formatting',
        'Clickable URLs',
        'Conversation tracking',
        'Thank you confirmations',
        'Improved error handling'
      ]
    };

    // DOM elements
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const chatSend = document.getElementById('chatSend');
    const typingIndicator = document.getElementById('typingIndicator');

    // State
    let isWaitingForResponse = false;
    let conversationHistory = [];
    let currentConversationId = null;

    // Auto-resize textarea
    chatInput.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });

    // Send on Enter (Shift+Enter for newline)
    chatInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    chatSend.addEventListener('click', sendMessage);

    // Parse markdown formatting
    function parseMarkdown(text) {
      // Bold: **text**
      text = text.replace(/\*\*([^\*]+)\*\*/g, '<strong>$1</strong>');
      // Italic: *text* (but not **)
      text = text.replace(/(?<!\*)\*([^\*]+)\*(?!\*)/g, '<em>$1</em>');
      return text;
    }

    // Convert URLs to clickable links
    function linkifyUrls(text) {
      const urlRegex = /(https?:\/\/[^\s]+)/g;
      return text.replace(urlRegex, function(match) {
        let url = match;
        let punctuation = '';
        
        // Check for trailing punctuation
        const trailingPunctuation = match.match(/[.,;:!?)]+$/);
        if (trailingPunctuation) {
          punctuation = trailingPunctuation[0];
          url = match.slice(0, -punctuation.length);
        }
        
        return `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>${punctuation}`;
      });
    }

    // Format text for display
    function formatTextForDisplay(text) {
      // Escape HTML first
      text = text.replace(/&/g, '&amp;')
                 .replace(/</g, '&lt;')
                 .replace(/>/g, '&gt;');
      
      // Parse markdown
      text = parseMarkdown(text);
      
      // Convert newlines to <br>
      text = text.replace(/\n/g, '<br>');
      
      // Convert URLs to links
      text = linkifyUrls(text);
      
      return text;
    }

    function showTyping() {
      typingIndicator.style.display = 'block';
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function hideTyping() {
      typingIndicator.style.display = 'none';
    }

    function addMessage(text, sender, conversationId = null) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${sender}`;
      
      const contentDiv = document.createElement('div');
      contentDiv.className = 'message-content';
      contentDiv.innerHTML = formatTextForDisplay(text);
      
      messageDiv.appendChild(contentDiv);
      
      // Add feedback buttons for bot messages
      if (sender === 'bot' && conversationId) {
        const feedbackDiv = document.createElement('div');
        feedbackDiv.className = 'feedback-buttons';
        
        const thumbsUp = document.createElement('button');
        thumbsUp.className = 'feedback-btn';
        thumbsUp.innerHTML = 'üëç Helpful';
        thumbsUp.onclick = () => sendFeedback(conversationId, 'positive', feedbackDiv);
        
        const thumbsDown = document.createElement('button');
        thumbsDown.className = 'feedback-btn';
        thumbsDown.innerHTML = 'üëé Not helpful';
        thumbsDown.onclick = () => sendFeedback(conversationId, 'negative', feedbackDiv);
        
        const emailBtn = document.createElement('button');
        emailBtn.className = 'feedback-btn email-cns-btn';
        emailBtn.innerHTML = 'üìß Email CNS';
        emailBtn.onclick = () => emailCNS();
        
        feedbackDiv.appendChild(thumbsUp);
        feedbackDiv.appendChild(thumbsDown);
        feedbackDiv.appendChild(emailBtn);
        
        messageDiv.appendChild(feedbackDiv);
      }
      
      chatMessages.insertBefore(messageDiv, typingIndicator);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    async function sendFeedback(conversationId, feedbackType, feedbackDiv) {
      try {
        // Disable all buttons in this feedback div
        const buttons = feedbackDiv.querySelectorAll('.feedback-btn');
        buttons.forEach(btn => btn.disabled = true);
        
        // Mark selected button
        const selectedBtn = Array.from(buttons).find(btn => 
          btn.innerHTML.includes(feedbackType === 'positive' ? 'üëç' : 'üëé')
        );
        if (selectedBtn) {
          selectedBtn.classList.add('selected');
        }
        
        await fetch(CONFIG.feedbackEndpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            conversationId: conversationId,
            feedback: feedbackType,
            sessionId: CONFIG.sessionId,
            timestamp: new Date().toISOString()
          })
        });
        
        // Show confirmation message
        showFeedbackConfirmation(feedbackDiv);
        
      } catch (error) {
        console.error('Error sending feedback:', error);
        // Re-enable buttons on error
        const buttons = feedbackDiv.querySelectorAll('.feedback-btn');
        buttons.forEach(btn => btn.disabled = false);
      }
    }

    function showFeedbackConfirmation(feedbackDiv) {
      const confirmation = document.createElement('div');
      confirmation.className = 'feedback-confirmation';
      confirmation.textContent = 'Thank you for your feedback!';
      feedbackDiv.parentNode.appendChild(confirmation);
      
      // Remove after animation
      setTimeout(() => {
        confirmation.remove();
      }, 3000);
    }

    function emailCNS() {
      // Build email with conversation context
      let emailBody = 'Hello CNS Team,%0D%0A%0D%0A';
      emailBody += 'I need additional help with my tech support issue.%0D%0A%0D%0A';
      emailBody += '--- Conversation History ---%0D%0A%0D%0A';
      
      conversationHistory.forEach(msg => {
        emailBody += `${msg.sender.toUpperCase()}: ${msg.text}%0D%0A%0D%0A`;
      });
      
      emailBody += '----------------------------%0D%0A%0D%0A';
      emailBody += 'Please let me know how you can help.%0D%0A%0D%0A';
      emailBody += 'Thank you!';
      
      const mailtoLink = `mailto:${CONFIG.cnsEmail}?subject=Tech Support Request - Follow Up&body=${emailBody}`;
      window.location.href = mailtoLink;
    }

    async function sendMessage() {
      const message = chatInput.value.trim();
      
      if (!message || isWaitingForResponse) {
        return;
      }

      // Add user message
      addMessage(message, 'user');
      conversationHistory.push({ sender: 'user', text: message });
      
      chatInput.value = '';
      chatInput.style.height = 'auto';

      // Disable input
      isWaitingForResponse = true;
      chatInput.disabled = true;
      chatSend.disabled = true;

      // Show typing
      showTyping();

      try {
        // Send to API
        const response = await fetch(CONFIG.chatEndpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            chatInput: message,
            sessionId: CONFIG.sessionId,
            version: APP_VERSION.version
          })
        });

        hideTyping();

        // Handle non-OK responses (rate limits, errors)
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          const errorMessage = errorData.message || errorData.error || 'An error occurred';
          
          // Create error object with status
          const error = new Error(errorMessage);
          error.status = response.status;
          throw error;
        }

        const data = await response.json();
        
        // Extract response text
        let botResponse = '';
        if (typeof data === 'string') {
          botResponse = data;
        } else if (data.message) {
          botResponse = data.message;
        } else if (data.output) {
          botResponse = data.output;
        } else if (data.ChatResponse) {
          botResponse = data.ChatResponse;
        } else {
          botResponse = JSON.stringify(data);
        }

        // Convert HTML br tags to newlines
        botResponse = botResponse.replace(/<br\s*\/?>/gi, '\n');

        // Get conversation ID
        currentConversationId = data.conversationId || data.conversation_id || null;

        // Add bot message
        addMessage(botResponse, 'bot', currentConversationId);
        conversationHistory.push({ sender: 'bot', text: botResponse });

      } catch (error) {
        console.error('Error sending message:', error);
        hideTyping();
        
        // Display appropriate error message based on status code
        let errorMessage;
        
        if (error.status === 429) {
          // Rate limit exceeded
          errorMessage = error.message || 'You\'ve reached the rate limit. Please wait a moment and try again.';
        } else if (error.status === 503) {
          // Service unavailable (global limit)
          errorMessage = error.message || 'The service is experiencing high traffic. Please try again in a few minutes or email cns@muskingum.edu for immediate assistance.';
        } else if (error.status === 403) {
          // Bot detected or forbidden
          errorMessage = error.message || 'Access denied. Please use a regular web browser to access this service.';
        } else if (error.status === 400) {
          // Bad request (validation error)
          errorMessage = error.message || 'Invalid request. Please check your input and try again.';
        } else {
          // Generic error
          errorMessage = 'Sorry, I\'m having trouble connecting. Please try again or email cns@muskingum.edu for help.';
        }
        
        addMessage(errorMessage, 'bot');
        
      } finally {
        // Re-enable input
        isWaitingForResponse = false;
        chatInput.disabled = false;
        chatSend.disabled = false;
        chatInput.focus();
      }
    }

    // Log version on load
    console.log('Tech Support Chat loaded:', APP_VERSION);
  </script>
</body>
</html>
