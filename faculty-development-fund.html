<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faculty Development Fund Request - Muskingum University</title>
    <!-- Version 1.3.0 - 2025-11-11 -->
    <!-- Changes: 
         - Updated Power Automate flow URL 
         - Improved error handling for empty/non-JSON responses
         - Added missing success-message CSS styling
    -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Calibri, Arial, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #DB0A5B;
        }

        .header h1 {
            color: #DB0A5B;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 16px;
        }

        .policy-link {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 4px;
            border-left: 4px solid #DB0A5B;
        }

        .policy-link a {
            color: #DB0A5B;
            text-decoration: none;
            font-weight: bold;
            font-size: 16px;
        }

        .policy-link a:hover {
            text-decoration: underline;
        }

        .section {
            margin-bottom: 30px;
        }

        .section-title {
            color: #DB0A5B;
            font-size: 20px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e1e1e1;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: bold;
        }

        input[type="text"],
        input[type="email"],
        input[type="date"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: Calibri, sans-serif;
        }

        input[type="text"]:focus,
        input[type="email"]:focus,
        input[type="date"]:focus,
        input[type="number"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #DB0A5B;
        }

        /* Hide spinner arrows on number inputs */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type="number"] {
            -moz-appearance: textfield;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .required {
            color: #DB0A5B;
        }

        .info-box {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 4px;
            border-left: 4px solid #DB0A5B;
            margin-bottom: 20px;
        }

        .links-box {
            background-color: #e8f4fd;
            padding: 15px;
            border-radius: 4px;
            border-left: 4px solid #0066cc;
            margin-bottom: 20px;
        }

        .links-box p {
            margin-bottom: 8px;
        }

        .links-box a {
            color: #0066cc;
            text-decoration: none;
            font-weight: 500;
        }

        .links-box a:hover {
            text-decoration: underline;
        }

        .checkbox-group {
            margin: 10px 0;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            font-weight: normal;
            margin-bottom: 8px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
        }

        .expense-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .expense-table th,
        .expense-table td {
            padding: 12px;
            text-align: left;
            border: 1px solid #ddd;
        }

        .expense-table th {
            background-color: #DB0A5B;
            color: white;
            font-weight: bold;
        }

        .expense-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .expense-table input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .total-row {
            background-color: #f0f0f0 !important;
            font-weight: bold;
        }

        .total-row td {
            font-size: 16px;
        }

        .total-value {
            color: #DB0A5B;
            font-size: 18px;
        }

        .mileage-input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .calculated-amount {
            color: #DB0A5B;
            font-weight: bold;
            font-size: 14px;
        }

        .validation-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            border-left: 4px solid #dc3545;
            margin-top: 15px;
            display: none;
        }

        .validation-message strong {
            display: block;
            margin-bottom: 5px;
        }

        .justification-box {
            background-color: #fff3cd;
            padding: 15px;
            border-radius: 4px;
            border-left: 4px solid #ffc107;
            margin-top: 15px;
            display: none;
        }

        .justification-box label {
            color: #856404;
            margin-bottom: 10px;
        }

        .justification-box textarea {
            border: 2px solid #ffc107;
            background-color: white;
            min-height: 100px;
        }

        .justification-box textarea:focus {
            border-color: #ff9800;
        }

        .button {
            background-color: #DB0A5B;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .button:hover {
            background-color: #b00848;
        }

        .button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .success-message {
            background-color: #d4edda;
            color: #155724;
            padding: 20px;
            border-radius: 4px;
            margin-top: 20px;
            display: none;
            text-align: center;
        }

        .success-message h3 {
            margin-bottom: 10px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #DB0A5B;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            color: #c00;
            font-weight: bold;
            margin-top: 10px;
            display: none;
        }

        .success-message {
            display: none;
            background-color: #d4edda;
            border: 2px solid #28a745;
            border-left: 5px solid #28a745;
            border-radius: 4px;
            padding: 25px;
            margin: 30px 0;
            text-align: center;
        }

        .success-message h3 {
            color: #155724;
            font-size: 24px;
            margin-bottom: 15px;
        }

        .success-message p {
            color: #155724;
            font-size: 16px;
            margin: 10px 0;
            line-height: 1.6;
        }

        .success-message strong {
            color: #0f4219;
            font-size: 18px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 22px;
            }
            
            .expense-table {
                font-size: 12px;
            }
            
            .expense-table th,
            .expense-table td {
                padding: 6px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Faculty Development Fund Request</h1>
            <p>Muskingum University</p>
        </div>

        <div class="policy-link">
            <a href="https://muskingum.sharepoint.com/:w:/r/sites/aa_academicaffairs-public-FacultyInformation/_layouts/15/Doc.aspx?sourcedoc=%7BD84657C1-BCB6-4B7E-A2BC-79A37EC36D2A%7D&file=Faculty%20professional%20development%20guide%2011.7.25.docx&action=default&mobileredirect=true" target="_blank">üìÑ Faculty Professional Development Guide</a>
        </div>

        <form id="fundingForm">
            <!-- Faculty Information -->
            <div class="section">
                <h2 class="section-title">Faculty Information</h2>
                
                <div class="form-group">
                    <label for="facultyName">
                        Faculty Name <span class="required">*</span>
                    </label>
                    <input type="text" id="facultyName" name="facultyName" required>
                </div>

                <div class="form-group">
                    <label for="facultyEmail">
                        Email Address <span class="required">*</span>
                    </label>
                    <input type="email" id="facultyEmail" name="facultyEmail" required>
                </div>

                <div class="form-group">
                    <label for="department">
                        Department <span class="required">*</span>
                    </label>
                    <select id="department" name="department" required>
                        <option value="">Select Department</option>
                        <option value="Art and Design">Art and Design</option>
                        <option value="Biology">Biology</option>
                        <option value="Business">Business</option>
                        <option value="Chemistry">Chemistry</option>
                        <option value="Computer Science">Computer Science</option>
                        <option value="Education">Education</option>
                        <option value="English">English</option>
                        <option value="History and Political Science">History and Political Science</option>
                        <option value="Mathematics">Mathematics</option>
                        <option value="Modern Languages">Modern Languages</option>
                        <option value="Music">Music</option>
                        <option value="Nursing">Nursing</option>
                        <option value="Philosophy and Religion">Philosophy and Religion</option>
                        <option value="Physics">Physics</option>
                        <option value="Psychology">Psychology</option>
                        <option value="Sociology">Sociology</option>
                        <option value="Theatre">Theatre</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="submissionDate">
                        Submission Date <span class="required">*</span>
                    </label>
                    <input type="date" id="submissionDate" name="submissionDate" required>
                </div>
            </div>

            <!-- Activity Information -->
            <div class="section">
                <h2 class="section-title">Professional Development Activity</h2>

                <div class="form-group">
                    <label>
                        Eligible Activities (check all that apply) <span class="required">*</span>
                    </label>
                    <div class="checkbox-group">
                        <label>
                            <input type="checkbox" name="activityType" value="Attending academic or professional conferences"> Attending academic or professional conferences
                        </label>
                        <label>
                            <input type="checkbox" name="activityType" value="Presenting papers or serving as a panelist or session chair"> Presenting papers or serving as a panelist or session chair
                        </label>
                        <label>
                            <input type="checkbox" name="activityType" value="Participating in workshops, seminars, or training programs"> Participating in workshops, seminars, or training programs
                        </label>
                        <label>
                            <input type="checkbox" name="activityType" value="Enrolling in courses or certifications relevant to one's discipline or teaching"> Enrolling in courses or certifications relevant to one's discipline or teaching
                        </label>
                        <label>
                            <input type="checkbox" name="activityType" value="Travel directly related to professional development"> Travel directly related to professional development
                        </label>
                        <label>
                            <input type="checkbox" name="activityType" value="Membership dues (one per year, cap of $200)"> Membership dues (one per year, cap of $200)
                        </label>
                        <label>
                            <input type="checkbox" name="activityType" value="Other" id="activityTypeOther"> Other (describe additional business-appropriate travel expenses):
                        </label>
                        <input type="text" id="otherActivityDesc" name="otherActivityDesc" placeholder="Describe other activity type" style="margin-left: 30px; margin-top: 5px; display: none;">
                    </div>
                </div>

                <div class="form-group">
                    <label for="activityDescription">
                        Activity Description <span class="required">*</span>
                    </label>
                    <textarea id="activityDescription" name="activityDescription" placeholder="Describe the professional development activity..." required></textarea>
                </div>

                <div class="form-group">
                    <label for="professionalValue">
                        Professional Value <span class="required">*</span>
                    </label>
                    <textarea id="professionalValue" name="professionalValue" placeholder="Explain how this activity enhances your professional development..." required></textarea>
                </div>

                <div class="form-group">
                    <label for="classArrangements">
                        Class Coverage Arrangements <span class="required">*</span>
                    </label>
                    <textarea id="classArrangements" name="classArrangements" placeholder="Describe how your classes will be covered during your absence..." required></textarea>
                </div>
            </div>

            <!-- Anticipated Expenses -->
            <div class="section">
                <h2 class="section-title">Anticipated Expenses</h2>
                
                <div class="info-box">
                    <strong>Note:</strong> The maximum funding approval is $1,000. Please enter your anticipated expenses below.
                </div>

                <div class="links-box">
                    <p style="margin-bottom: 10px;"><strong>Use the US General Service Administration allowances for reimbursable expenses.</strong> Click on "Plan a Trip" to identify the amounts, which are based on destination and time of year. Note these remain in effect up to September 2026.</p>
                    <p>üìç <strong>Domestic travel:</strong> <a href="https://www.gsa.gov/travel" target="_blank">https://www.gsa.gov/travel</a></p>
                    <p>üåç <strong>International travel:</strong> <a href="https://allowances.state.gov/web920/per_diem.asp" target="_blank">https://allowances.state.gov/web920/per_diem.asp</a></p>
                </div>

                <table class="expense-table">
                    <thead>
                        <tr>
                            <th>Expense Category</th>
                            <th>Anticipated Expense (USD)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Membership Dues<br><small style="color: #666;">*One per year, cap of $200</small></td>
                            <td><input type="number" step="0.01" min="0" id="membershipDues" name="membershipDues" placeholder="0.00" value="0" class="expense-input"></td>
                        </tr>
                        <tr>
                            <td>Air Travel</td>
                            <td><input type="number" step="0.01" min="0" id="airTravel" name="airTravel" placeholder="0.00" value="0" class="expense-input"></td>
                        </tr>
                        <tr>
                            <td>Mileage <small>($0.70 per mile)</small></td>
                            <td>
                                <div class="mileage-input-group">
                                    <input type="number" step="1" min="0" id="mileageMiles" name="mileageMiles" placeholder="Enter miles" value="0">
                                    <div class="calculated-amount">= $<span id="mileageCalc">0.00</span></div>
                                    <input type="hidden" id="mileage" name="mileage" value="0">
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>Ground Travel</td>
                            <td><input type="number" step="0.01" min="0" id="groundTravel" name="groundTravel" placeholder="0.00" value="0" class="expense-input"></td>
                        </tr>
                        <tr>
                            <td>Registration Costs</td>
                            <td><input type="number" step="0.01" min="0" id="registrationCosts" name="registrationCosts" placeholder="0.00" value="0" class="expense-input"></td>
                        </tr>
                        <tr>
                            <td>Lodging</td>
                            <td><input type="number" step="0.01" min="0" id="lodging" name="lodging" placeholder="0.00" value="0" class="expense-input"></td>
                        </tr>
                        <tr>
                            <td>Meals & Incidentals</td>
                            <td><input type="number" step="0.01" min="0" id="mealsIncidentals" name="mealsIncidentals" placeholder="0.00" value="0" class="expense-input"></td>
                        </tr>
                        <tr>
                            <td>Other Expenses<br><small><input type="text" id="otherExpenseDesc" name="otherExpenseDesc" placeholder="Describe other expenses" style="margin-top: 5px;"></small></td>
                            <td><input type="number" step="0.01" min="0" id="otherExpense" name="otherExpense" placeholder="0.00" value="0" class="expense-input"></td>
                        </tr>
                        <tr class="total-row">
                            <td><strong>Total Anticipated ($1,000 maximum)</strong></td>
                            <td><span class="total-value" id="totalAnticipated">$0.00</span></td>
                        </tr>
                    </tbody>
                </table>

                <div id="validationMessage" class="validation-message"></div>

                <div id="justificationBox" class="justification-box">
                    <label for="exceededLimitJustification">
                        <strong>Justification Required:</strong> Please explain why you are requesting an amount that exceeds the standard limits. Is there an additional budget(s) that is sharing the costs? Please explain.
                    </label>
                    <textarea id="exceededLimitJustification" name="exceededLimitJustification" placeholder="Enter your justification here..."></textarea>
                </div>
            </div>

            <!-- Signature -->
            <div class="section">
                <h2 class="section-title">Faculty Signature</h2>
                
                <div class="form-group">
                    <label for="facultySignature">
                        Type Your Full Name as Digital Signature <span class="required">*</span>
                    </label>
                    <input type="text" id="facultySignature" name="facultySignature" placeholder="Your Full Name" required>
                </div>

                <div class="info-box">
                    <p><strong>By typing your name above, you certify that:</strong></p>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li>All information provided is accurate and complete</li>
                        <li>You will submit actual expenses within one month of activity completion</li>
                        <li>You will provide receipts and documentation for reimbursement</li>
                    </ul>
                </div>
            </div>

            <!-- Submit Button -->
            <div style="text-align: center; margin-top: 30px;">
                <button type="submit" class="button" id="submitBtn">
                    Submit Request
                </button>
            </div>

            <div class="loading" id="loading">
                <div class="loading-spinner"></div>
                <p>Submitting your request...</p>
            </div>

            <div class="success-message" id="successMessage">
                <h3>‚úì Request Submitted Successfully!</h3>
                <p id="requestIdDisplay"></p>
                <p>You will receive a confirmation email shortly.</p>
                <p>Your department chair has been notified and will review your request.</p>
            </div>

            <div class="error-message" id="errorMessage"></div>
        </form>
    </div>

    <script>
        const MILEAGE_RATE = 0.70;
        const MAX_TOTAL = 1000;
        const MAX_MEMBERSHIP_DUES = 200;

        // Set today's date as default
        document.getElementById('submissionDate').valueAsDate = new Date();

        // Show/hide "Other" activity description field
        document.getElementById('activityTypeOther').addEventListener('change', function() {
            const otherDescField = document.getElementById('otherActivityDesc');
            if (this.checked) {
                otherDescField.style.display = 'block';
            } else {
                otherDescField.style.display = 'none';
                otherDescField.value = ''; // Clear value when hidden
            }
        });

        // Mileage calculation
        document.getElementById('mileageMiles').addEventListener('input', function() {
            const miles = parseFloat(this.value) || 0;
            const dollars = miles * MILEAGE_RATE;
            document.getElementById('mileageCalc').textContent = dollars.toFixed(2);
            document.getElementById('mileage').value = dollars.toFixed(2);
            calculateTotal();
        });

        // Validate limits and show/hide justification box
        function validateLimits(total) {
            const membershipDues = parseFloat(document.getElementById('membershipDues').value) || 0;
            
            const validationMessage = document.getElementById('validationMessage');
            const justificationBox = document.getElementById('justificationBox');
            
            let messages = [];
            let showJustification = false;

            // Check total limit
            if (total > MAX_TOTAL) {
                messages.push(`‚ö†Ô∏è Warning: Anticipated total exceeds the $${MAX_TOTAL.toLocaleString()} maximum funding limit.`);
                showJustification = true;
            }

            // Check membership dues limit
            if (membershipDues > MAX_MEMBERSHIP_DUES) {
                messages.push(`‚ö†Ô∏è Warning: Membership Dues exceed the $${MAX_MEMBERSHIP_DUES} maximum limit.`);
                showJustification = true;
            }

            // Display messages
            if (messages.length > 0) {
                validationMessage.innerHTML = messages.join('<br>');
                validationMessage.style.display = 'block';
            } else {
                validationMessage.style.display = 'none';
            }

            // Show/hide justification box
            if (showJustification) {
                justificationBox.style.display = 'block';
            } else {
                justificationBox.style.display = 'none';
                document.getElementById('exceededLimitJustification').value = ''; // Clear justification when hidden
            }
        }

        // Calculate total anticipated expenses
        function calculateTotal() {
            const membershipDues = parseFloat(document.getElementById('membershipDues').value) || 0;
            const airTravel = parseFloat(document.getElementById('airTravel').value) || 0;
            const mileage = parseFloat(document.getElementById('mileage').value) || 0;
            const groundTravel = parseFloat(document.getElementById('groundTravel').value) || 0;
            const registrationCosts = parseFloat(document.getElementById('registrationCosts').value) || 0;
            const lodging = parseFloat(document.getElementById('lodging').value) || 0;
            const mealsIncidentals = parseFloat(document.getElementById('mealsIncidentals').value) || 0;
            const otherExpense = parseFloat(document.getElementById('otherExpense').value) || 0;

            const total = membershipDues + airTravel + mileage + groundTravel + registrationCosts + lodging + mealsIncidentals + otherExpense;
            
            document.getElementById('totalAnticipated').textContent = '$' + total.toFixed(2);

            // Update color based on limit
            if (total > MAX_TOTAL) {
                document.getElementById('totalAnticipated').style.color = '#c00';
            } else {
                document.getElementById('totalAnticipated').style.color = '#DB0A5B';
            }

            // Validate limits after calculation
            validateLimits(total);

            return total;
        }

        // Add event listeners to all expense inputs
        document.querySelectorAll('.expense-input').forEach(input => {
            input.addEventListener('input', calculateTotal);
        });

        // Get selected activity types
        function getSelectedActivities() {
            const checkboxes = document.querySelectorAll('input[name="activityType"]:checked');
            const selected = Array.from(checkboxes).map(cb => {
                if (cb.value === 'Other') {
                    const otherDesc = document.getElementById('otherActivityDesc').value.trim();
                    return otherDesc ? `Other: ${otherDesc}` : 'Other';
                }
                return cb.value;
            });
            return selected.join(', ');
        }

        // Form submission
        document.getElementById('fundingForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            // Validate activity type selected
            const selectedActivities = getSelectedActivities();
            if (!selectedActivities) {
                alert('Please select at least one activity type.');
                return;
            }

            // Validate total doesn't exceed $1000 (with confirmation if it does)
            const total = calculateTotal();
            const membershipDues = parseFloat(document.getElementById('membershipDues').value) || 0;
            const exceededLimitJustification = document.getElementById('exceededLimitJustification').value.trim();

            if (total > MAX_TOTAL || membershipDues > MAX_MEMBERSHIP_DUES) {
                if (!exceededLimitJustification) {
                    alert('Please provide a justification for exceeding the standard limits.');
                    document.getElementById('exceededLimitJustification').focus();
                    return;
                }
            }

            // Show loading, hide button
            document.getElementById('loading').style.display = 'block';
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('errorMessage').style.display = 'none';

            // Prepare form data
            const formData = {
                FacultyName: document.getElementById('facultyName').value,
                FacultyEmail: document.getElementById('facultyEmail').value,
                Department: document.getElementById('department').value,
                SubmissionDate: document.getElementById('submissionDate').value,
                EligibleActivities: selectedActivities,
                ActivityDescription: document.getElementById('activityDescription').value,
                ProfessionalValue: document.getElementById('professionalValue').value,
                ClassArrangements: document.getElementById('classArrangements').value,
                MembershipDues: parseFloat(document.getElementById('membershipDues').value) || 0,
                AirTravel: parseFloat(document.getElementById('airTravel').value) || 0,
                Mileage: parseFloat(document.getElementById('mileage').value) || 0,
                MileageMiles: parseFloat(document.getElementById('mileageMiles').value) || 0,
                GroundTravel: parseFloat(document.getElementById('groundTravel').value) || 0,
                RegistrationCosts: parseFloat(document.getElementById('registrationCosts').value) || 0,
                Lodging: parseFloat(document.getElementById('lodging').value) || 0,
                MealsIncidentals: parseFloat(document.getElementById('mealsIncidentals').value) || 0,
                OtherExpense: parseFloat(document.getElementById('otherExpense').value) || 0,
                OtherExpenseDesc: document.getElementById('otherExpenseDesc').value,
                TotalAnticipated: total,
                ExceededLimitJustification: exceededLimitJustification,
                FacultySignature: document.getElementById('facultySignature').value
            };

            // Power Automate Flow URL
            const flowUrl = 'https://defaultcb41821671ce4827beea96b956d0a0.04.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/a149a0856a644843b2a5369bc1807d9d/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=u-LWmXxDP-pzboBUTJnVDczE5ATL5Xu_-LC0_yj6pP0';

            try {
                const response = await fetch(flowUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                document.getElementById('loading').style.display = 'none';

                if (!response.ok) {
                    throw new Error(`Submission failed with status: ${response.status}`);
                }

                // Try to parse JSON, but handle empty responses
                let data = {};
                const responseText = await response.text();
                console.log('Response from Power Automate:', responseText);
                
                if (responseText) {
                    try {
                        data = JSON.parse(responseText);
                    } catch (parseError) {
                        console.warn('Response is not JSON:', responseText);
                    }
                }

                // Show success message
                document.getElementById('requestIdDisplay').innerHTML = '<strong>Request ID: ' + (data.requestID || 'Pending') + '</strong>';
                document.getElementById('successMessage').style.display = 'block';
                
                // Hide form
                document.getElementById('fundingForm').style.display = 'none';

            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('submitBtn').disabled = false;
                document.getElementById('errorMessage').textContent = 'Error submitting request. Please try again or contact support. Check console for details.';
                document.getElementById('errorMessage').style.display = 'block';
                console.error('Error:', error);
            }
        });
    </script>
</body>
</html>
