<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travel Waiver Completion</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Calibri, 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #DB0A5B;
            text-align: center;
            font-family: Calibri, sans-serif;
            font-weight: 600;
            margin-bottom: 30px;
        }
        h3 {
            color: #DB0A5B;
            font-family: Calibri, sans-serif;
            margin-bottom: 10px;
        }
        h4 {
            color: #DB0A5B;
            font-family: Calibri, sans-serif;
            margin-top: 0;
        }
        .trip-info {
            background-color: #fef0f5;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #DB0A5B;
        }
        .trip-info p {
            margin: 8px 0;
            font-family: Calibri, sans-serif;
        }
        .additional-info-section {
            background-color: #fef0f5;
            padding: 25px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #DB0A5B;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-family: Calibri, sans-serif;
        }
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e1e1;
            border-radius: 4px;
            font-size: 14px;
            font-family: Calibri, sans-serif;
            transition: border-color 0.3s;
        }
        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #DB0A5B;
        }
        .form-group small {
            display: block;
            margin-top: 5px;
            font-size: 12px;
            font-family: Calibri, sans-serif;
        }
        .required {
            color: #DB0A5B;
        }
        .waiver-content {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid #DB0A5B;
        }
        .waiver-content p {
            margin: 15px 0;
            font-family: Calibri, sans-serif;
            line-height: 1.6;
        }
        .agreement-section {
            margin: 30px 0;
            padding: 20px;
            background-color: #fff8e1;
            border-radius: 8px;
            border-left: 4px solid #DB0A5B;
        }
        .checkbox-container {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin: 20px 0;
        }
        .checkbox-container input[type="checkbox"] {
            margin-top: 5px;
            transform: scale(1.2);
        }
        .checkbox-container label {
            font-family: Calibri, sans-serif;
            line-height: 1.6;
        }
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background-color 0.3s;
            width: 100%;
            font-family: Calibri, sans-serif;
        }
        .btn-primary {
            background-color: #DB0A5B;
            color: white;
        }
        .btn-primary:hover {
            background-color: #b50849;
        }
        .btn-primary:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .message {
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
            text-align: center;
            font-family: Calibri, sans-serif;
        }
        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
            color: #DB0A5B;
            font-family: Calibri, sans-serif;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Travel Waiver Completion</h1>
        
        <div id="tripInfo" class="trip-info" style="display: none;">
            <h3>Travel Information</h3>
            <p><strong>Destination:</strong> <span id="tripDestination"></span></p>
            <p><strong>Faculty Organizer:</strong> <span id="facultyName"></span></p>
            <p><strong>Dates:</strong> <span id="tripDates"></span></p>
            <p><strong>Purpose of Travel:</strong> <span id="purposeOfTravel"></span></p>
            <p><strong>Student Name:</strong> <span id="studentName"></span></p>
        </div>

        <div class="message" id="messageDiv" style="display: none;"></div>
        <div class="loading" id="loadingDiv">
            <p>Loading waiver information...</p>
        </div>

        <div id="waiverForm" style="display: none;">
            <div class="waiver-content">
                <h4>Travel Waiver and Release Form</h4>
                <p><strong>Students must read and complete this Waiver and Release prior to participating in any student travel.</strong></p>
                
                <p>I, the undersigned, agree to the following:</p>
                
                <p><strong>(1)</strong> I shall indemnify Muskingum University ("University") and hold harmless its agents and its employees from all liability, losses, costs, claims, damages, and expenses, including attorney's fees, arising or claimed to have arisen out of personal injuries or death, or property damage or loss, sustained by me as a result of participating in this academic, athletic, or University-supported activity, however caused, including, without limitation claimed negligence on the part of University employees, other participants, or third parties. In addition, I shall indemnify the University, its agents and employees from all liability, losses, costs, claims, damages, and expenses, including attorney's fees, relating to claims or injury arising from my own negligence or intentional acts during my participation in this program (including travel to and from the activity sites) and I hereby RELEASE and forever DISCHARGE the University and its agents and employees from all such liability, loss, costs, claims, damages, or expenses.</p>
                
                <p><strong>(2)</strong> I understand that the employee(s) for the activity are acting in their respective capacities as agents of the University, not individually, and hereby waive any and all claims I may have or purport to have against the University or against employee(s) individually for losses occasioned by any changes in travel plans, or for the failure of any of the companies providing transportation, lodging, meals, tour services, or other goods or services, as applies to the nature of this activity, to provide such services on a timely basis or for the failure to provide them at all.</p>
                
                <p><strong>(3)</strong> The University has the right to make cancellations, changes, or substitutions in the course, agenda, program, assigned employee(s), travel arrangements, or arrangements for other services, in the event of causes beyond its reasonable control, significantly changed conditions, or changes in the interests of the group.</p>
                
                <p><strong>(4)</strong> I am solely responsible for obtaining and keeping safe my personal possessions, documents, money, travel tickets (as needed), and other property. I hereby WAIVE and RELEASE the University, and any assigned employee and volunteer, from any and all claims for expenses or losses of any nature and amount due to my failure to do so.</p>
                
                <p><strong>(5)</strong> In the event of illness or injury requiring medical care, I hereby authorize the employee to contact emergency services, if needed, or transport me to an appropriate medical facility, if requested. I authorize notification of my emergency contact. I hereby assume both physical risk associated with and responsibility for the cost of any medical treatment. It is my responsibility to obtain and keep in force adequate health insurance while traveling. I understand and agree I am financially responsible for my own medical expenses, and that any advance medical payment made by the University through the employee on my behalf shall be reimbursed to the University immediately.</p>
                
                <p><strong>(6)</strong> I understand and agree that while participating in the activity, I remain subject to the University's rules, regulations, and policies. I agree to adhere to such rules, regulations, and policies during my participation in the activity.</p>
                
                <p><strong>(7)</strong> I hereby authorize disclosure by the University to the emergency contact listed below of any academic or other relevant information regarding my participation in the activity. I WAIVE my rights as defined by the Family Right to Education Privacy Act (FERPA) for this purpose.</p>
                
                <p style="font-weight: 700; margin-top: 20px;"><strong>I have read and understand this document and agree that it will legally bind me, my heirs and assigns, and my estate.</strong></p>
            </div>

            <div class="additional-info-section">
                <h4>Additional Information Required</h4>
                
                <div class="form-group">
                    <label for="studentPhone">Student Phone Number <span class="required">*</span></label>
                    <input type="tel" id="studentPhone" placeholder="(555) 123-4567" required>
                </div>
                
                <div class="form-group">
                    <label for="emergencyContact">Emergency Contact Name <span class="required">*</span></label>
                    <input type="text" id="emergencyContact" placeholder="Full name of emergency contact" required>
                </div>
                
                <div class="form-group">
                    <label for="relationship">Relationship <span class="required">*</span></label>
                    <input type="text" id="relationship" placeholder="e.g., Parent, Spouse, Guardian" required>
                </div>
                
                <div class="form-group">
                    <label for="emergencyPhone">Emergency Contact Phone Number <span class="required">*</span></label>
                    <input type="tel" id="emergencyPhone" placeholder="(555) 123-4567" required>
                </div>
                
                <div class="form-group">
                    <label for="additionalInfo">Additional Information to Disclose</label>
                    <textarea id="additionalInfo" rows="4" placeholder="Please disclose any medical conditions, dietary restrictions, accessibility needs, or other information the faculty organizer should be aware of (optional)"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="studentSignature">Digital Signature <span class="required">*</span></label>
                    <input type="text" id="studentSignature" placeholder="Type your full name as your digital signature" required>
                    <small style="color: #666; font-style: italic;">By typing your name above, you are providing your legal digital signature</small>
                </div>
            </div>

            <div class="agreement-section">
                <div class="checkbox-container">
                    <input type="checkbox" id="agreeCheckbox" required>
                    <label for="agreeCheckbox">
                        <strong>I have read, understood, and agree to all terms and conditions outlined in this Travel Waiver and Release Form.</strong>
                        I understand that this agreement is binding and that I am voluntarily assuming all risks associated with this travel activity.
                    </label>
                </div>
            </div>

            <button id="submitBtn" class="btn btn-primary" disabled onclick="submitWaiver()">
                Complete Travel Waiver
            </button>
        </div>
    </div>

    <script>
        // Configuration - UPDATE THESE VALUES
        const WAIVER_FLOW_URL = 'https://defaultcb41821671ce4827beea96b956d0a0.04.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/e54dcbe9c1a34116ade7c0e8e4bcd130/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=Asr6M4EzFKHGzVmAgj68o6ZN7I5jd2Oa9NmGlYBHXEo';

        // Get URL parameters
        function getUrlParameters() {
            const params = new URLSearchParams(window.location.search);
            return {
                noticeId: params.get('noticeId'),
                trackingCode: params.get('tracking'),
                email: params.get('email'),
                tripName: params.get('tripName'),
                dates: params.get('dates'),
                facultyName: params.get('facultyName'),
                studentName: params.get('studentName'),
                purposeOfTravel: params.get('purpose')
            };
        }

        function showMessage(type, text) {
            const messageDiv = document.getElementById('messageDiv');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = text;
            messageDiv.style.display = 'block';
        }

        function showLoading(show) {
            document.getElementById('loadingDiv').style.display = show ? 'block' : 'none';
        }

        async function loadWaiverInfo() {
            const params = getUrlParameters();
            
            if (!params.noticeId || !params.trackingCode || !params.email) {
                showMessage('error', 'Invalid waiver link. Please contact your faculty organizer.');
                return;
            }

            try {
                showLoading(true);

                // Store parameters for later use
                window.waiverData = {
                    noticeId: params.noticeId,
                    trackingCode: params.trackingCode,
                    studentEmail: params.email,
                    studentName: params.studentName || 'Student'
                };

                // Display trip information from URL parameters
                document.getElementById('tripDestination').textContent = params.tripName || 'See email for details';
                document.getElementById('facultyName').textContent = params.facultyName || 'See email for details';
                document.getElementById('tripDates').textContent = params.dates || 'See email for details';
                document.getElementById('purposeOfTravel').textContent = params.purposeOfTravel || 'See email for details';
                document.getElementById('studentName').textContent = params.studentName || 'Student';

                // Show the form
                document.getElementById('tripInfo').style.display = 'block';
                document.getElementById('waiverForm').style.display = 'block';
                showLoading(false);

            } catch (error) {
                console.error('Error:', error);
                showMessage('error', 'Error loading waiver information. Please try again or contact your faculty organizer.');
                showLoading(false);
            }
        }

        async function submitWaiver() {
            if (!document.getElementById('agreeCheckbox').checked) {
                showMessage('error', 'Please check the agreement box to complete your waiver.');
                return;
            }

            // Validate required fields
            const studentPhone = document.getElementById('studentPhone').value.trim();
            const emergencyContact = document.getElementById('emergencyContact').value.trim();
            const relationship = document.getElementById('relationship').value.trim();
            const emergencyPhone = document.getElementById('emergencyPhone').value.trim();
            const studentSignature = document.getElementById('studentSignature').value.trim();

            if (!studentPhone || !emergencyContact || !relationship || !emergencyPhone || !studentSignature) {
                showMessage('error', 'Please fill in all required fields.');
                return;
            }

            try {
                document.getElementById('submitBtn').disabled = true;
                document.getElementById('submitBtn').textContent = 'Submitting...';

                const additionalInfo = document.getElementById('additionalInfo').value.trim();

                const payload = {
                    NoticeId: window.waiverData.noticeId,
                    TrackingCode: window.waiverData.trackingCode,
                    StudentEmail: window.waiverData.studentEmail,
                    StudentName: window.waiverData.studentName,
                    StudentPhone: studentPhone,
                    EmergencyContact: emergencyContact,
                    Relationship: relationship,
                    EmergencyPhone: emergencyPhone,
                    StudentSignature: studentSignature,
                    AdditionalInformationtoDisclose: additionalInfo
                };

                // Call Power Automate Flow 3
                const response = await axios.post(WAIVER_FLOW_URL, payload, {
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.data.success) {
                    showMessage('success', 'Travel waiver completed successfully! Thank you for your participation.');
                    document.getElementById('waiverForm').style.display = 'none';
                } else {
                    throw new Error(response.data.message || 'Unknown error occurred');
                }

            } catch (error) {
                console.error('Error:', error);
                showMessage('error', 'Error submitting waiver. Please try again or contact your faculty organizer.');
                document.getElementById('submitBtn').disabled = false;
                document.getElementById('submitBtn').textContent = 'Complete Travel Waiver';
            }
        }

        // Enable/disable submit button based on checkbox
        document.getElementById('agreeCheckbox').addEventListener('change', function() {
            document.getElementById('submitBtn').disabled = !this.checked;
        });

        // Load waiver info when page loads
        window.addEventListener('load', loadWaiverInfo);
    </script>
</body>
</html>
